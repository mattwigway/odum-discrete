<!DOCTYPE html>
<html lang="en"><head>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/tabby.min.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-html.min.css" rel="stylesheet" data-mode="light">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.0.37">

  <meta name="author" content="Matt Bhagat-Conway">
  <meta name="dcterms.date" content="2022-08-11">
  <title>Data Matters Discrete Choice Models - Introduction to discrete choice models in R</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
      }
    pre.numberSource { margin-left: 3em;  padding-left: 4px; }
    div.sourceCode
      { color: #f8f8f2;  }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #f8f8f2; } /* Normal */
    code span.al { color: #f07178; background-color: #2a0f15; font-weight: bold; } /* Alert */
    code span.an { color: #d4d0ab; } /* Annotation */
    code span.at { color: #00e0e0; } /* Attribute */
    code span.bn { color: #d4d0ab; } /* BaseN */
    code span.bu { color: #abe338; } /* BuiltIn */
    code span.cf { color: #ffa07a; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #abe338; } /* Char */
    code span.cn { color: #ffd700; } /* Constant */
    code span.co { color: #f8f8f2; font-style: italic; } /* Comment */
    code span.cv { color: #ffd700; } /* CommentVar */
    code span.do { color: #f8f8f2; } /* Documentation */
    code span.dt { color: #ffa07a; } /* DataType */
    code span.dv { color: #d4d0ab; } /* DecVal */
    code span.er { color: #f07178; text-decoration: underline; } /* Error */
    code span.ex { color: #00e0e0; font-weight: bold; } /* Extension */
    code span.fl { color: #d4d0ab; } /* Float */
    code span.fu { color: #ffa07a; } /* Function */
    code span.im { color: #abe338; } /* Import */
    code span.in { color: #d4d0ab; } /* Information */
    code span.kw { color: #ffa07a; font-weight: bold; } /* Keyword */
    code span.op { color: #ffa07a; } /* Operator */
    code span.ot { color: #00e0e0; } /* Other */
    code span.pp { color: #dcc6e0; } /* Preprocessor */
    code span.re { color: #00e0e0; background-color: #f8f8f2; } /* RegionMarker */
    code span.sc { color: #abe338; } /* SpecialChar */
    code span.ss { color: #abe338; } /* SpecialString */
    code span.st { color: #abe338; } /* String */
    code span.va { color: #00e0e0; } /* Variable */
    code span.vs { color: #abe338; } /* VerbatimString */
    code span.wa { color: #dcc6e0; } /* Warning */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
    }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
  <link rel="stylesheet" href="site_libs/revealjs/dist/theme/quarto.css" id="theme">
  <link href="site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">

  .callout {
    margin-top: 1em;
    margin-bottom: 1em;  
    border-radius: .25rem;
  }

  .callout.callout-style-simple { 
    padding: 0em 0.5em;
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
    display: flex;
  }

  .callout.callout-style-default {
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
  }

  .callout .callout-body-container {
    flex-grow: 1;
  }

  .callout.callout-style-simple .callout-body {
    font-size: 1rem;
    font-weight: 400;
  }

  .callout.callout-style-default .callout-body {
    font-size: 0.9rem;
    font-weight: 400;
  }

  .callout.callout-captioned.callout-style-simple .callout-body {
    margin-top: 0.2em;
  }

  .callout:not(.callout-captioned) .callout-body {
      display: flex;
  }

  .callout:not(.no-icon).callout-captioned.callout-style-simple .callout-content {
    padding-left: 1.6em;
  }

  .callout.callout-captioned .callout-header {
    padding-top: 0.2em;
    margin-bottom: -0.2em;
  }

  .callout.callout-captioned .callout-caption  p {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
    
  .callout.callout-captioned.callout-style-simple .callout-content  p {
    margin-top: 0;
  }

  .callout.callout-captioned.callout-style-default .callout-content  p {
    margin-top: 0.7em;
  }

  .callout.callout-style-simple div.callout-caption {
    border-bottom: none;
    font-size: .9rem;
    font-weight: 600;
    opacity: 75%;
  }

  .callout.callout-style-default  div.callout-caption {
    border-bottom: none;
    font-weight: 600;
    opacity: 85%;
    font-size: 0.9rem;
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-default div.callout-content {
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-simple .callout-icon::before {
    height: 1rem;
    width: 1rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 1rem 1rem;
  }

  .callout.callout-style-default .callout-icon::before {
    height: 0.9rem;
    width: 0.9rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 0.9rem 0.9rem;
  }

  .callout-caption {
    display: flex
  }
    
  .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  .callout.no-icon::before {
    display: none !important;
  }

  .callout.callout-captioned .callout-body > .callout-content > :last-child {
    margin-bottom: 0.5rem;
  }

  .callout.callout-captioned .callout-icon::before {
    margin-top: .5rem;
    padding-right: .5rem;
  }

  .callout:not(.callout-captioned) .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  /* Callout Types */

  div.callout-note {
    border-left-color: #4582ec !important;
  }

  div.callout-note .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEU0lEQVRYCcVXTWhcVRQ+586kSUMMxkyaElstCto2SIhitS5Ek8xUKV2poatCcVHtUlFQk8mbaaziwpWgglJwVaquitBOfhQXFlqlzSJpFSpIYyXNjBNiTCck7x2/8/LeNDOZxDuEkgOXe++553zfefee+/OYLOXFk3+1LLrRdiO81yNqZ6K9cG0P3MeFaMIQjXssE8Z1JzLO9ls20MBZX7oG8w9GxB0goaPrW5aNMp1yOZIa7Wv6o2ykpLtmAPs/vrG14Z+6d4jpbSKuhdcSyq9wGMPXjonwmESXrriLzFGOdDBLB8Y6MNYBu0dRokSygMA/mrun8MGFN3behm6VVAwg4WR3i6FvYK1T7MHo9BK7ydH+1uurECoouk5MPRyVSBrBHMYwVobG2aOXM07sWrn5qgB60rc6mcwIDJtQrnrEr44kmy+UO9r0u9O5/YbkS9juQckLed3DyW2XV/qWBBB3ptvI8EUY3I9p/67OW+g967TNr3Sotn3IuVlfMLVnsBwH4fsnebJvyGm5GeIUA3jljERmrv49SizPYuq+z7c2H/jlGC+Ghhupn/hcapqmcudB9jwJ/3jvnvu6vu5lVzF1fXyZuZZ7U8nRmVzytvT+H3kilYvH09mLWrQdwFSsFEsxFVs5fK7A0g8gMZjbif4ACpKbjv7gNGaD8bUrlk8x+KRflttr22JEMRUbTUwwDQScyzPgedQHZT0xnx7ujw2jfVfExwYHwOsDTjLdJ2ebmeQIlJ7neo41s/DrsL3kl+W2lWvAga0tR3zueGr6GL78M3ifH0rGXrBC2aAR8uYcIA5gwV8zIE8onoh8u0Fca/ciF7j1uOzEnqcIm59sEXoGc0+z6+H45V1CvAvHcD7THztu669cnp+L0okAeIc6zjbM/24LgGM1gZk7jnRu1aQWoU9sfUOuhrmtaPIO3YY1KLLWZaEO5TKUbMY5zx8W9UJ6elpLwKXbsaZ4EFl7B4bMtDv0iRipKoDQT2sNQI9b1utXFdYisi+wzZ/ri/1m7QfDgEuvgUUEIJPq3DhX/5DWNqIXDOweC2wvIR90Oq3lDpdMIgD2r0dXvGdsEW5H6x6HLRJYU7C69VefO1x8Gde1ZFSJLfWS1jbCnhtOPxmpfv2LXOA2Xk2tvnwKKPFuZ/oRmwBwqRQDcKNeVQkYcOjtWVBuM/JuYw5b6isojIkYxyYAFn5K7ZBF10fea52y8QltAg6jnMqNHFBmGkQ1j+U43HMi2xMar1Nv0zGsf1s8nUsmUtPOOrbFIR8bHFDMB5zL13Gmr/kGlCkUzedTzzmzsaJXhYawnA3UmARpiYj5ooJZiUoxFRtK3X6pgNPv+IZVPcnwbOl6f+aBaO1CNvPW9n9LmCp01nuSaTRF2YxHqZ8DYQT6WsXT+RD6eUztwYLZ8rM+rcPxamv1VQzFUkzFXvkiVrySGQgJNvXHJAxiU3/NwiC03rSf05VBaPtu/Z7/B8Yn/w7eguloAAAAAElFTkSuQmCC');
  }

  div.callout-note.callout-style-default .callout-caption {
    background-color: #dae6fb
  }

  div.callout-important {
    border-left-color: #d9534f !important;
  }

  div.callout-important .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEKklEQVRYCcVXTWhcVRS+575MJym48A+hSRFr00ySRQhURRfd2HYjk2SSTokuBCkU2o0LoSKKraKIBTcuFCoidGFD08nkBzdREbpQ1EDNIv8qSGMFUboImMSZd4/f9zJv8ibJMC8xJQfO3HPPPef7zrvvvnvviIkpC9nsw0UttFunbUhpFzFtarSd6WJkStVMw5xyVqYTvkwfzuf/5FgtkVoB0729j1rjXwThS7Vio+Mo6DNnvLfahoZ+i/o32lULuJ3NNiz7q6+pyAUkJaFF6JwaM2lUJlV0MlnQn5aTRbEu0SEqHUa0A4AdiGuB1kFXRfVyg5d87+Dg4DL6m2TLAub60ilj7A1Ec4odSAc8X95sHh7+ZRPCFo6Fnp7HfU/fBng/hi10CjCnWnJjsxvDNxWw0NfV6Rv5GgP3I3jGWXumdTD/3cbEOP2ZbOZp69yniG3FQ9z1jD7bnBu9Fc2tKGC2q+uAJOQHBDRiZX1x36o7fWBs7J9ownbtO+n0/qWkvW7UPIfc37WgT6ZGR++EOJyeQDSb9UB+DZ1G6DdLDzyS+b/kBCYGsYgJbSQHuThGKRcw5xdeQf8YdNHsc6ePXrlSYMBuSIAFTGAtQo+VuALo4BX83N190NWZWbynBjhOHsmNfFWLeL6v+ynsA58zDvvAC8j5PkbOcXCMg2PZFk3q8MjI7WAG/Dp9AwP7jdGBOOQkAvlFUB+irtm16I1Zw9YBcpGTGXYmk3kQIC/Cds55l+iMI3jqhjAuaoe+am2Jw5GT3Nbz3CkE12NavmzN5+erJW7046n/CH1RO/RVa8lBLozXk9uqykkGAyRXLWlLv5jyp4RFsG5vGVzpDLnIjTWgnRy2Rr+tDKvRc7Y8AyZq10jj8DqXdnIRNtFZb+t/ZRtXcDiVnzpqx8mPcDWxgARUqx0W1QB9MeUZiNrV4qP+Ehc+BpNgATsTX8ozYKL2NtFYAHc84fG7ndxUPr+AR/iQSns7uSUufAymwDOb2+NjK27lEFocm/EE2WpyIy/Hi66MWuMKJn8RvxIcj87IM5Vh9663ziW36kR0HNenXuxmfaD8JC7tfKbrhFr7LiZCrMjrzTeGx+PmkosrkNzW94ObzwocJ7A1HokLolY+AvkTiD/q1H0cN48c5EL8Crkttsa/AXQVDmutfyku0E7jShx49XqV3MFK8IryDhYVbj7Sj2P2eBxwcXoe8T8idsKKPRcnZw1b+slFTubwUwhktrfnAt7J++jwQtLZcm3sr9LQrjRzz6cfMv9aLvgmnAGvpoaGLxM4mAEaLV7iAzQ3oU0IvD5x9ix3yF2RAAuYAOO2f7PEFWCXZ4C9Pb2UsgDeVnFSpbFK7/IWu7TPTvBqzbGdCHOJQSxiEjt6IyZmxQyEJHv6xyQsYk//moVFsN2zP6fRImjfq7/n/wFDguUQFNEwugAAAABJRU5ErkJggg==');
  }

  div.callout-important.callout-style-default .callout-caption {
    background-color: #f7dddc
  }

  div.callout-warning {
    border-left-color: #f0ad4e !important;
  }

  div.callout-warning .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAETklEQVRYCeVWW2gcVRg+58yaTUnizqbipZeX4uWhBEniBaoUX1Ioze52t7sRq6APio9V9MEaoWlVsFasRq0gltaAPuxms8lu0gcviE/FFOstVbSIxgcv6SU7EZqmdc7v9+9mJtNks51NTUH84ed889/PP+cmxP+d5FIbMJmNbpREu4WUkiTtCicKny0l1pIKmBzovF2S+hIJHX8iEu3hZJ5lNZGqyRrGSIQpq15AzF28jgpeY6yk6GVdrfFqdrD6Iw+QlB8g0YS2g7dyQmXM/IDhBhT0UCiRf59lfqmmDvzRt6kByV/m4JjtzuaujMUM2c5Z2d6JdKrRb3K2q6mA+oYVz8JnDdKPmmNthzkAk/lN63sYPgevrguc72aZX/L9C6x09GYyxBgCX4NlvyGUHOKELlm5rXeR1kchuChJt4SSwyddZRXgvwMGvYo4QSlk3/zkHD8UHxwVJA6zjZZqP8v8kK8OWLnIZtLyCAJagYC4rTGW/9Pqj92N/c+LUaAj27movwbi19tk/whRCIE7Q9vyI6yvRpftAKVTdUjOW40X3h5OXsKCdmFcx0xlLJoSuQngnrJe7Kcjm4OMq9FlC7CMmScQANuNvjfP3PjGXDBaUQmbp296S5L4DrpbrHN1T87ZVEZVCzg1FF0Ft+dKrlLukI+/c9ENo+TvlTDbYFvuKPtQ9+l052rXrgKoWkDAFnvh0wTOmYn8R5f4k/jN/fZiCM1tQx9jQQ4ANhqG4hiL0qIFTGViG9DKB7GYzgubnpofgYRwO+DFjh0Zin2m4b/97EDkXkc+f6xYAPX0KK2I/7fUQuwzuwo/L3AkcjugPNixC8cHf0FyPjWlItmLxWw4Ou9YsQCr5fijMGoD/zpdRy95HRysyXA74MWOnscpO4j2y3HAVisw85hX5+AFBRSHt4ShfLFkIMXTqyKFc46xdzQM6XbAi702a7sy04J0+feReMFKp5q9esYLCqAZYw/k14E/xcLLsFElaornTuJB0svMuJINy8xkIYuL+xPAlWRceH6+HX7THJ0djLUom46zREu7tTkxwmf/FdOZ/sh6Q8qvEAiHpm4PJ4a/doJe0gH1t+aHRgCzOvBvJedEK5OFE5jpm4AGP2a8Dxe3gGJ/pAutug9Gp6he92CsSsWBaEcxGx0FHytmIpuqGkOpldqNYQK8cSoXvd+xLxXADw0kf6UkJNFtdo5MOgaLjiQOQHcn+A6h5NuL2s0qsC2LOM75PcF3yr5STuBSAcGG+meA14K/CI21HcS4LBT6tv0QAh8Dr5l93AhZzG5ZJ4VxAqdZUEl9z7WJ4aN+svMvwHHL21UKTd1mqvChH7/Za5xzXBBKrUcB0TQ+Ulgkfbi/H/YT5EptrGzsEK7tR1B7ln9BBwckYfMiuSqklSznIuoIIOM42MQO+QnduCoFCI0bpkzjCjddHPN/F+2Yu+sd9bKNpVwHhbS3LluK/0zgfwD0xYI5dXuzlQAAAABJRU5ErkJggg==');
  }

  div.callout-warning.callout-style-default .callout-caption {
    background-color: #fcefdc
  }

  div.callout-tip {
    border-left-color: #02b875 !important;
  }

  div.callout-tip .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAADr0lEQVRYCe1XTWgTQRj9ZjZV8a9SPIkKgj8I1bMHsUWrqYLVg4Ue6v9BwZOxSYsIerFao7UiUryIqJcqgtpimhbBXoSCVxUFe9CTiogUrUp2Pt+3aUI2u5vdNh4dmMzOzHvvezuz8xNFM0mjnbXaNu1MvFWRXkXEyE6aYOYJpdW4IXuA4r0fo8qqSMDBU0v1HJUgVieAXxzCsdE/YJTdFcVIZQNMyhruOMJKXYFoLfIfIvVIMWdsrd+Rpd86ZmyzzjJmLStqRn0v8lzkb4rVIXvnpScOJuAn2ACC65FkPzEdEy4TPWRLJ2h7z4cArXzzaOdKlbOvKKX25Wl00jSnrwVxAg3o4dRxhO13RBSdNvH0xSARv3adTXbBdTf64IWO2vH0LT+cv4GR1DJt+DUItaQogeBX/chhbTBxEiZ6gftlDNXTrvT7co4ub5A6gp9HIcHvzTa46OS5fBeP87Qm0fQkr4FsYgVQ7Qg+ZayaDg9jhg1GkWj8RG6lkeSacrrHgDaxdoBiZPg+NXV/KifMuB6//JmYH4CntVEHy/keA6x4h4CU5oFy8GzrBS18cLJMXcljAKB6INjWsRcuZBWVaS3GDrqB7rdapVIeA+isQ57Eev9eCqzqOa81CY05VLd6SamW2wA2H3SiTbnbSxmzfp7WtKZkqy4mdyAlGx7ennghYf8voqp9cLSgKdqNfa6RdRsAAkPwRuJZNbpByn+RrJi1RXTwdi8RQF6ymDwGMAtZ6TVE+4uoKh+MYkcLsT0Hk8eAienbiGdjJHZTpmNjlbFJNKDVAp2fJlYju6IreQxQ08UJDNYdoLSl6AadO+fFuCQqVMB1NJwPm69T04Wv5WhfcWyfXQB+wXRs1pt+nCknRa0LVzSA/2B+a9+zQJadb7IyyV24YAxKp2Jqs3emZTuNnKxsah+uabKbMk7CbTgJx/zIgQYErIeTKRQ9yD9wxVof5YolPHqaWo7TD6tJlh7jQnK5z2n3+fGdggIOx2kaa2YI9QWarc5Ce1ipNWMKeSG4DysFF52KBmTNMmn5HqCFkwy34rDg05gDwgH3bBi+sgFhN/e8QvRn8kbamCOhgrZ9GJhFDgfcMHzFb6BAtjKpFhzTjwv1KCVuxHvCbsSiEz4CANnj84cwHdFXAbAOJ4LTSAawGWFn5tDhLMYz6nWeU2wJfIhmIJBefcd/A5FWQWGgrWzyORZ3Q6HuV+Jf0Bj+BTX69fm1zWgK7By1YTXchFDORywnfQ7GpzOo6S+qECrsx2ifVQAAAABJRU5ErkJggg==');
  }

  div.callout-tip.callout-style-default .callout-caption {
    background-color: #ccf1e3
  }

  div.callout-caution {
    border-left-color: #fd7e14 !important;
  }

  div.callout-caution .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAACV0lEQVRYCdVWzWoUQRCuqp2ICBLJXgITZL1EfQDBW/bkzUMUD7klD+ATSHBEfAIfQO+iXsWDxJsHL96EHAwhgzlkg8nBg25XWb0zIb0zs9muYYWkoKeru+vn664fBqElyZNuyh167NXJ8Ut8McjbmEraKHkd7uAnAFku+VWdb3reSmRV8PKSLfZ0Gjn3a6Xlcq9YGb6tADjn+lUfTXtVmaZ1KwBIvFI11rRXlWlatwIAAv2asaa9mlB9wwygiDX26qaw1yYPzFXg2N1GgG0FMF8Oj+VIx7E/03lHx8UhvYyNZLN7BwSPgekXXLribw7w5/c8EF+DBK5idvDVYtEEwMeYefjjLAdEyQ3M9nfOkgnPTEkYU+sxMq0BxNR6jExrAI31H1rzvLEfRIdgcv1XEdj6QTQAS2wtstEALLG1yEZ3QhH6oDX7ExBSFEkFINXH98NTrme5IOaaA7kIfiu2L8A3qhH9zRbukdCqdsA98TdElyeMe5BI8Rs2xHRIsoTSSVFfCFCWGPn9XHb4cdobRIWABNf0add9jakDjQJpJ1bTXOJXnnRXHRf+dNL1ZV1MBRCXhMbaHqGI1JkKIL7+i8uffuP6wVQAzO7+qVEbF6NbS0LJureYcWXUUhH66nLR5rYmva+2tjRFtojkM2aD76HEGAD3tPtKM309FJg5j/K682ywcWJ3PASCcycH/22u+Bh7Aa0ehM2Fu4z0SAE81HF9RkB21c5bEn4Dzw+/qNOyXr3DCTQDMBOdhi4nAgiFDGCinIa2owCEChUwD8qzd03PG+qdW/4fDzjUMcE1ZpIAAAAASUVORK5CYII=');
  }

  div.callout-caution.callout-style-default .callout-caption {
    background-color: #ffe5d0
  }

  </style>
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
  <script src="site_libs/quarto-diagram/mermaid.min.js"></script>
  <script src="site_libs/quarto-diagram/mermaid-init.js"></script>
  <link href="site_libs/quarto-diagram/mermaid.css" rel="stylesheet">
</head>
<body class="quarto-dark">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="center">
  <h1 class="title">Introduction to discrete choice models in R</h1>
  <p class="author">Matt Bhagat-Conway</p>
  <p class="institute">Odum Institute<br>University of North Carolina at Chapel Hill</p>
  <p class="date">August 11, 2022</p>
</section>

<section id="about-me" class="slide level2">
<h2>About me</h2>
<div class="cell">

</div>
<ul>
<li>Assistant professor of City and Regional Planning</li>
<li>Research focus: transportation modeling and simulation
<ul>
<li>Heavy use of discrete choice models</li>
</ul></li>
<li>PhD in Geography from Arizona State</li>
<li>Three years experience as transportation modeling software developer</li>
</ul>
</section>
<section id="before-we-go-any-further" class="slide level2">
<h2>Before we go any further</h2>
<ul>
<li>Slides, code, and data at <a href="https://projects.indicatrix.org/odum-discrete/">https://projects.indicatrix.org/odum-discrete/</a></li>
</ul>
</section>
<section id="before-we-go-any-further-1" class="slide level2">
<h2>Before we go any further</h2>
<ul>
<li>If you haven’t already installed R, RStudio, <code>apollo</code>, and <code>tidyverse</code>, do so now</li>
<li>R: <a href="https://r-project.org">https://r-project.org</a></li>
<li>RStudio: <a href="https://rstudio.com">https://rstudio.com</a></li>
<li><code>apollo</code> and <code>tidyverse</code>: in RStudio console, run:</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">install.packages</span>(<span class="st">"tidyverse"</span>)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">install.packages</span>(<span class="st">"apollo"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="what-are-discrete-choice-models" class="slide level2">
<h2>What are discrete choice models?</h2>
<ul>
<li>Any model of a variable that takes on discrete values</li>
<li>Could be binary (two values), categorical (more than two values), or quantized (e.g., integers)</li>
</ul>
</section>
<section id="types-of-discrete-choice-models" class="slide level2">
<h2>Types of discrete choice models</h2>
<ul>
<li>Random utility models
<ul>
<li>Logistic regression, multinomial logistic regression, ordered logit, mixed logit</li>
</ul></li>
<li>Count models
<ul>
<li>Poisson and negative binomial regression</li>
</ul></li>
<li>Machine learning
<ul>
<li>Random forests, support vector machines, <em>k</em> nearest neighbors</li>
</ul></li>
</ul>
</section>
<section id="random-utility-theory" class="slide level2">
<h2>Random utility theory</h2>
<ul>
<li>Individuals are maximizing the <em>utility</em> of their choices</li>
<li>Utility is an abstract concept of value</li>
<li>Individuals choose the choice with the highest utility</li>
<li>Utility is random because there is a random component to utility</li>
<li>We won’t know which choice is the highest utility for an individual, only the probabilities that a particular choice will have the highest utility</li>
</ul>
</section>
<section>
<section id="binary-logistic-regression" class="title-slide slide level1 center">
<h1>Binary logistic regression</h1>

</section>
<section id="binary-logistic-regression-1" class="slide level2">
<h2>Binary logistic regression</h2>
<ul>
<li>A very common model for binary (yes/no) outcomes</li>
<li>Probably familiar to many</li>
<li>Usually presented as a generalized linear model</li>
</ul>
</section>
<section id="binary-logistic-regression-intuition" class="slide level2">
<h2>Binary logistic regression: Intuition</h2>
<ul>
<li>Linear functions can take on any value</li>
<li>Probabilities need to be between 0 and 1</li>
<li>The logit function transforms arbitrary linear values to (0, 1)</li>
</ul>
</section>
<section id="binary-logistic-regression-the-math" class="slide level2">
<h2>Binary logistic regression: the math</h2>
<p><span class="math display">\[
y^* = \alpha + \beta_1 x_1 + \beta_2 x_2 \cdots + \epsilon
\]</span></p>
<p><span class="math display">\[
\epsilon \thicksim \mathrm{Logistic}
\]</span></p>
<p><span class="math display">\[
p(y = 1) = p(y^* &gt; 0) = \frac{e^{y^*}}{1 + e^{y^*}}
\]</span></p>
</section>
<section id="the-logit-function" class="slide level2">
<h2>The logit function</h2>
<!-- run logistic regression -->

<img data-src="discrete-choice_files/figure-revealjs/unnamed-chunk-3-1.svg" alt="Logistic regression, showing sigmoid function" width="1200" class="r-stretch quarto-figure-center"></section>
<section id="logistic-regression-in-r" class="slide level2">
<h2>Logistic regression in R</h2>
<p><code>nhts-carpool-glm.R</code></p>
<div class="cell" data-filename="nhts-carpool-glm.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-4_c4ba8bff9388d0f440b2979b54e7f890">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a>data <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="st">"data/nhts/carpool.csv"</span>)</span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a>glm_model <span class="ot">=</span> <span class="fu">glm</span>(carpool<span class="sc">~</span>hhsize<span class="sc">+</span>cars_per_driver<span class="sc">+</span>commute<span class="sc">+</span>social,</span>
<span id="cb2-6"><a href="#cb2-6"></a>    <span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link=</span><span class="st">"logit"</span>), data)</span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="fu">summary</span>(glm_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="logistic-regression-in-r-1" class="slide level2">
<h2>Logistic regression in R</h2>
<div class="cell" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-5_c23b5ba86fb5dd796cc580d79c335a34">
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = carpool ~ hhsize + cars_per_driver + commute + 
    social, family = binomial(link = "logit"), data = data)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.1680  -1.1291  -0.4298   1.1035   2.3704  

Coefficients:
                Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)     -0.69705    0.10562  -6.600 4.12e-11 ***
hhsize           0.39411    0.02483  15.872  &lt; 2e-16 ***
cars_per_driver -0.20591    0.06124  -3.362 0.000773 ***
commuteTRUE     -1.82661    0.11851 -15.413  &lt; 2e-16 ***
socialTRUE       0.36877    0.09771   3.774 0.000161 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 6927.6  on 4999  degrees of freedom
Residual deviance: 6301.9  on 4995  degrees of freedom
AIC: 6311.9

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
</section>
<section id="binary-logistic-regression-as-a-random-utility-model" class="slide level2">
<h2>Binary logistic regression as a random utility model</h2>
<ul>
<li>We can treat the linear predictor in logistic regression as the utility of the modeled outcome</li>
<li>In this case, the utility of carpooling</li>
<li>We also need a utility of not carpooling</li>
<li>Decisionmakers will choose the highest utility <em>alternative</em></li>
</ul>
</section>
<section id="binary-logistic-regression-as-a-random-utility-model-1" class="slide level2">
<h2>Binary logistic regression as a random utility model</h2>
<ul>
<li>Utilities are only meaningful relative to each other</li>
<li>Usual practice is to set utility of one alternative to 0</li>
</ul>
</section>
<section id="binary-logistic-regression-as-a-random-utility-model-2" class="slide level2">
<h2>Binary logistic regression as a random utility model</h2>
<p><span class="math display">\[
y^* = \alpha + \beta_1 x_1 + \beta_2 x_2 \cdots + \epsilon
\]</span></p>
<p><span class="math display">\[
p(y = 1) = p(y^* &gt; 0)\\= \frac{e^{y^*}}{1 + e^{y^*}}
\]</span></p>
</section>
<section id="binary-logistic-regression-as-a-random-utility-model-3" class="slide level2">
<h2>Binary logistic regression as a random utility model</h2>
<p><span class="math display">\[
U_{y=1} = \alpha + \beta_1 x_1 + \beta_2 x_2 \cdots + \epsilon_1
\]</span></p>
<p><span class="math display">\[
U_{y=0} = 0 + \epsilon_0
\]</span></p>
<p><span class="math display">\[
p(y = 1) = p(U_{y=1} &gt; U_{y=0})\\= \frac{e^{U_{y=1}}}{e^{U_{y=0}} + e^{U_{y=1}}}
\]</span></p>
</section>
<section id="binary-logistic-regression-as-a-random-utility-model-in-r" class="slide level2">
<h2>Binary logistic regression as a random utility model in R</h2>
<p><code>nhts-carpool-apollo.R</code></p>
<div class="cell" data-filename="nhts-carpool-apollo.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-7_cd7ca6bc75f24a4f58694445c495ea59">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">library</span>(apollo)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co"># Read data - variable must be called "database"</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>database <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="st">"data/nhts/carpool.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="nhts-carpool-apollo.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-8_2d0185790338db8ca615d556e3f847ee">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># Initialize Apollo library</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="fu">apollo_initialise</span>()</span>
<span id="cb5-3"><a href="#cb5-3"></a></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co"># set parameters for overall model</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>apollo_control <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb5-6"><a href="#cb5-6"></a>    <span class="at">modelName=</span><span class="st">"Carpool_binary"</span>,</span>
<span id="cb5-7"><a href="#cb5-7"></a>    <span class="at">indivID=</span><span class="st">"id"</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="nhts-carpool-apollo.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-9_f28fb68482f9797b5522cdd992d81d6e">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># In Apollo, you specify your utility functions by hand,</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co"># first telling Apollo what coefficients to estimate</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>apollo_beta <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb6-4"><a href="#cb6-4"></a>    <span class="at">constant_carpool =</span> <span class="dv">0</span>, <span class="co"># 0 is starting value</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>    <span class="at">b_hhsize =</span> <span class="dv">0</span>,</span>
<span id="cb6-6"><a href="#cb6-6"></a>    <span class="at">b_cars_per_driver =</span> <span class="dv">0</span>,</span>
<span id="cb6-7"><a href="#cb6-7"></a>    <span class="at">b_commute =</span> <span class="dv">0</span>,</span>
<span id="cb6-8"><a href="#cb6-8"></a>    <span class="at">b_social =</span> <span class="dv">0</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>)</span>
<span id="cb6-10"><a href="#cb6-10"></a></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="co"># any parameters that you want to remain constant go here</span></span>
<span id="cb6-12"><a href="#cb6-12"></a>apollo_fixed <span class="ot">=</span> <span class="fu">c</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="nhts-carpool-apollo.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-10_b32393a346d8a9c88c6049d4643c3728">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># prepare the inputs to the Apollo estimation code</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>apollo_inputs <span class="ot">=</span> <span class="fu">apollo_validateInputs</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>All checks on apollo_control completed.
All checks on database completed.</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="nhts-carpool-apollo.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-11_2c9669efedb36bc44041eee1003a2817">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="co"># this function calculates probabilities of each alternative</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>apollo_probabilities <span class="ot">=</span> <span class="cf">function</span>(apollo_beta, apollo_inputs,</span>
<span id="cb9-3"><a href="#cb9-3"></a>        <span class="at">functionality=</span><span class="st">"estimate"</span>) {</span>
<span id="cb9-4"><a href="#cb9-4"></a>    <span class="co"># so we can refer to variables by name</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>    <span class="fu">apollo_attach</span>(apollo_beta, apollo_inputs)</span>
<span id="cb9-6"><a href="#cb9-6"></a>    <span class="fu">on.exit</span>(<span class="fu">apollo_detach</span>(apollo_beta, apollo_inputs))</span>
<span id="cb9-7"><a href="#cb9-7"></a></span>
<span id="cb9-8"><a href="#cb9-8"></a>    <span class="co"># This is the list of probabilities for the alternatives</span></span>
<span id="cb9-9"><a href="#cb9-9"></a>    <span class="co"># for each observation</span></span>
<span id="cb9-10"><a href="#cb9-10"></a>    P <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb9-11"><a href="#cb9-11"></a></span>
<span id="cb9-12"><a href="#cb9-12"></a>    <span class="co"># Define utility functions</span></span>
<span id="cb9-13"><a href="#cb9-13"></a>    V <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb9-14"><a href="#cb9-14"></a>    V[[<span class="st">"carpool"</span>]] <span class="ot">=</span> constant_carpool <span class="sc">+</span> b_hhsize <span class="sc">*</span> hhsize <span class="sc">+</span></span>
<span id="cb9-15"><a href="#cb9-15"></a>        b_cars_per_driver <span class="sc">*</span> cars_per_driver <span class="sc">+</span></span>
<span id="cb9-16"><a href="#cb9-16"></a>        b_commute <span class="sc">*</span> commute <span class="sc">+</span> b_social <span class="sc">*</span> social</span>
<span id="cb9-17"><a href="#cb9-17"></a>    V[[<span class="st">"not_carpool"</span>]] <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb9-18"><a href="#cb9-18"></a></span>
<span id="cb9-19"><a href="#cb9-19"></a>    <span class="co"># associate utility functions with data</span></span>
<span id="cb9-20"><a href="#cb9-20"></a>    logit_settings <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb9-21"><a href="#cb9-21"></a>        <span class="at">alternatives =</span> <span class="fu">c</span>(<span class="at">carpool=</span>T, <span class="at">not_carpool=</span>F),</span>
<span id="cb9-22"><a href="#cb9-22"></a>        <span class="at">avail        =</span> <span class="fu">list</span>(<span class="at">carpool=</span>T, <span class="at">not_carpool=</span>T),</span>
<span id="cb9-23"><a href="#cb9-23"></a>        <span class="at">choiceVar    =</span> carpool,</span>
<span id="cb9-24"><a href="#cb9-24"></a>        <span class="at">utilities    =</span> V</span>
<span id="cb9-25"><a href="#cb9-25"></a>    )</span>
<span id="cb9-26"><a href="#cb9-26"></a></span>
<span id="cb9-27"><a href="#cb9-27"></a>    <span class="co"># compute probabilities</span></span>
<span id="cb9-28"><a href="#cb9-28"></a>    P[[<span class="st">"model"</span>]] <span class="ot">=</span> <span class="fu">apollo_mnl</span>(logit_settings, functionality)</span>
<span id="cb9-29"><a href="#cb9-29"></a></span>
<span id="cb9-30"><a href="#cb9-30"></a>    P <span class="ot">=</span> <span class="fu">apollo_prepareProb</span>(P, apollo_inputs, functionality)</span>
<span id="cb9-31"><a href="#cb9-31"></a>    <span class="fu">return</span>(P)</span>
<span id="cb9-32"><a href="#cb9-32"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="nhts-carpool-apollo.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-12_705bc9d05dee3c9118bb81a54e8e8792">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># finally, estimate the model</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>model <span class="ot">=</span> <span class="fu">apollo_estimate</span>(apollo_beta, apollo_fixed,</span>
<span id="cb10-3"><a href="#cb10-3"></a>    apollo_probabilities, apollo_inputs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Preparing user-defined functions.

Testing likelihood function...

Overview of choices for MNL model component :
                                 carpool not_carpool
Times available                   5000.0      5000.0
Times chosen                      2430.0      2570.0
Percentage chosen overall           48.6        51.4
Percentage chosen when available    48.6        51.4

Pre-processing likelihood function...

Testing influence of parameters
Starting main estimation
Initial function value: -3465.736 
Initial gradient value:
 constant_carpool          b_hhsize b_cars_per_driver         b_commute 
         -70.0000          571.5000         -187.2226         -199.5000 
         b_social 
          51.5000 
initial  value 3465.735903 
iter   2 value 3462.049070
iter   3 value 3404.483122
iter   4 value 3266.363837
iter   5 value 3260.544356
iter   6 value 3252.724971
iter   7 value 3163.319397
iter   8 value 3151.229542
iter   9 value 3150.963126
iter  10 value 3150.958622
iter  11 value 3150.958331
iter  11 value 3150.958327
iter  11 value 3150.958327
final  value 3150.958327 
converged
Additional convergence test using scaled estimation. Parameters will be
  scaled by their current estimates and additional iterations will be
  performed.
initial  value 3150.958327 
iter   1 value 3150.958327
final  value 3150.958327 
converged
Estimated parameters:
                     Estimate
constant_carpool      -0.6971
b_hhsize               0.3941
b_cars_per_driver     -0.2059
b_commute             -1.8266
b_social               0.3688

Computing covariance matrix using analytical gradient.
 0%....25%....50%...100%
Negative definite Hessian with maximum eigenvalue: -69.347981
Computing score matrix...
Calculating LL(0) for applicable models...
Calculating LL(c) for applicable models...
Calculating LL of each model component...</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="nhts-carpool-apollo.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-13_1ebb222e7e4ffa6c08217ed33c97e081">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="co"># print results</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="fu">apollo_modelOutput</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model run by mwbc using Apollo 0.2.7 on R 4.2.1 for Darwin.
www.ApolloChoiceModelling.com

Model name                       : Carpool_binary
Model description                : No model description provided in apollo_control
Model run at                     : 2022-08-10 12:28:22
Estimation method                : bfgs
Model diagnosis                  : successful convergence 
Number of individuals            : 5000
Number of rows in database       : 5000
Number of modelled outcomes      : 5000

Number of cores used             :  1 
Model without mixing

LL(start)                        : -3465.74
LL(0)                            : -3465.74
LL(C)                            : -3463.78
LL(final)                        : -3150.96
Rho-square (0)                   :  0.0908 
Adj.Rho-square (0)               :  0.0894 
Rho-square (C)                   :  0.0903 
Adj.Rho-square (C)               :  0.0889 
AIC                              :  6311.92 
BIC                              :  6344.5 

Estimated parameters             :  5
Time taken (hh:mm:ss)            :  00:00:0.46 
     pre-estimation              :  00:00:0.25 
     estimation                  :  00:00:0.06 
     post-estimation             :  00:00:0.15 
Iterations                       :  15  
Min abs eigenvalue of Hessian    :  69.34798 

Unconstrained optimisation.

Estimates:
                     Estimate        s.e.   t.rat.(0)    Rob.s.e. Rob.t.rat.(0)
constant_carpool      -0.6971     0.10562      -6.600     0.10562        -6.600
b_hhsize               0.3941     0.02483      15.871     0.02527        15.595
b_cars_per_driver     -0.2059     0.06124      -3.362     0.06171        -3.337
b_commute             -1.8266     0.11851     -15.413     0.12392       -14.740
b_social               0.3688     0.09771       3.774     0.09735         3.788</code></pre>
</div>
</div>
</section>
<section id="but-dont-take-my-word-for-it" class="slide level2">
<h2>But don’t take my word for it…</h2>
<div class="cell" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-14_c5b1daf32d912b389c45ac9f2a3df08c">
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = carpool ~ hhsize + cars_per_driver + commute + 
    social, family = binomial(link = "logit"), data = data)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.1680  -1.1291  -0.4298   1.1035   2.3704  

Coefficients:
                Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)     -0.69705    0.10562  -6.600 4.12e-11 ***
hhsize           0.39411    0.02483  15.872  &lt; 2e-16 ***
cars_per_driver -0.20591    0.06124  -3.362 0.000773 ***
commuteTRUE     -1.82661    0.11851 -15.413  &lt; 2e-16 ***
socialTRUE       0.36877    0.09771   3.774 0.000161 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 6927.6  on 4999  degrees of freedom
Residual deviance: 6301.9  on 4995  degrees of freedom
AIC: 6311.9

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
</section></section>
<section id="questions" class="title-slide slide level1 center">
<h1>Questions?</h1>

</section>

<section>
<section id="the-multinomial-logit-model" class="title-slide slide level1 center">
<h1>The multinomial logit model</h1>

</section>
<section id="what-about-more-than-two-outcomes" class="slide level2">
<h2>What about more than two outcomes?</h2>
<ul>
<li>Random utility theory doesn’t constrain us to two outcomes</li>
<li>We can have many outcomes, and decisionmakers choose the one with the highest utility</li>
<li>This is known as a <em>multinomial</em> model</li>
</ul>
</section>
<section id="extending-logistic-regression-to-the-multinomial-case" class="slide level2">
<h2>Extending logistic regression to the multinomial case</h2>
<ul>
<li>Instead of two utilities <span class="math inline">\(U_{y=1}\)</span> and <span class="math inline">\(U_{y=0}\)</span>, we have arbitrary number of utility functions <span class="math inline">\(U_i\)</span></li>
<li>Decisionmakers choose the option with the highest utility</li>
<li>As with binary logistic regression, utility functions are usually linear combinations of parameters</li>
</ul>
</section>
<section id="multinomial-logistic-regression-the-math" class="slide level2">
<h2>Multinomial logistic regression: the math</h2>
<ul>
<li>Probability then becomes</li>
</ul>
<p><span class="math display">\[
p(y=i)\\= p(U_i &gt; \mathrm{all~other}~U)\\
    =\frac{e^{U_i}}{e^{U_1} + e^{U_2} \cdots}\\
    =\frac{e^{U_i}}{\sum_{j \in I} e^{U_j}}
\]</span></p>
</section>
<section id="multinomial-logistic-regression-in-r" class="slide level2">
<h2>Multinomial logistic regression in R</h2>
<ul>
<li>We will build a model of working from home expectation post-pandemic, using data from the <a href="https://covidfuture.org">COVID Future</a> study.</li>
<li>We will estimate four utility functions, for being unable to, rarely, frequently, and always working from home</li>
<li>Based on age, income, and job type</li>
</ul>
</section>
<section id="multinomial-logistic-regression-in-r-1" class="slide level2">
<h2>Multinomial logistic regression in R</h2>
<p>` - These utility functions will have the same variables but different coefficients - Each will also have a <em>alternative specific constant</em>—like a constant in logistic regression that represents the base rate, but for each alternative - One utility function will be held at zero</p>
</section>
<section id="multinomial-logistic-regression-in-r-2" class="slide level2">
<h2>Multinomial logistic regression in R</h2>
<p><code>covidfuture-wfh-mnl.R</code></p>
<div class="cell" data-filename="covidfuture-wfh-mnl.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-16_1975716c4e3657f6d7a731744f183479">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">library</span>(apollo)</span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb15-3"><a href="#cb15-3"></a></span>
<span id="cb15-4"><a href="#cb15-4"></a>database <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="st">"data/covidfuture_wfh.csv"</span>)</span>
<span id="cb15-5"><a href="#cb15-5"></a></span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="fu">apollo_initialise</span>()</span>
<span id="cb15-7"><a href="#cb15-7"></a></span>
<span id="cb15-8"><a href="#cb15-8"></a>apollo_control <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb15-9"><a href="#cb15-9"></a>    <span class="at">modelName=</span><span class="st">"WFH_Postpandemic"</span>,</span>
<span id="cb15-10"><a href="#cb15-10"></a>    <span class="at">indivID=</span><span class="st">"resp_id"</span></span>
<span id="cb15-11"><a href="#cb15-11"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="covidfuture-wfh-mnl.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-17_593bb5eea6c6a9be8f5eb8776231798d">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="fu">head</span>(database)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  resp_id wfh      age income_100k_plus service_worker
    &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;lgl&gt;            &lt;lgl&gt;         
1    1201 Often     29 TRUE             FALSE         
2    1228 Often     28 TRUE             FALSE         
3    1229 Often     25 FALSE            TRUE          
4    1230 Unable    36 FALSE            FALSE         
5    1231 Unable    33 FALSE            FALSE         
6    1233 Often     30 FALSE            FALSE         </code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="covidfuture-wfh-mnl.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-18_2481b50b0e0dc83a626018381cae9dc5">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="co"># now, we must define all the coefficients</span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="co"># we have separate sets of coefficients for each utility</span></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="co"># function, because the utilities need to be different</span></span>
<span id="cb18-4"><a href="#cb18-4"></a>apollo_beta <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb18-5"><a href="#cb18-5"></a>    <span class="at">asc_rarely =</span> <span class="dv">0</span>,</span>
<span id="cb18-6"><a href="#cb18-6"></a>    <span class="at">asc_often =</span> <span class="dv">0</span>,</span>
<span id="cb18-7"><a href="#cb18-7"></a>    <span class="at">asc_always =</span> <span class="dv">0</span>,</span>
<span id="cb18-8"><a href="#cb18-8"></a>    <span class="at">b_rarely_age =</span> <span class="dv">0</span>,</span>
<span id="cb18-9"><a href="#cb18-9"></a>    <span class="at">b_often_age =</span> <span class="dv">0</span>,</span>
<span id="cb18-10"><a href="#cb18-10"></a>    <span class="at">b_always_age =</span> <span class="dv">0</span>,</span>
<span id="cb18-11"><a href="#cb18-11"></a>    <span class="at">b_rarely_highinc =</span> <span class="dv">0</span>,</span>
<span id="cb18-12"><a href="#cb18-12"></a>    <span class="at">b_often_highinc =</span> <span class="dv">0</span>,</span>
<span id="cb18-13"><a href="#cb18-13"></a>    <span class="at">b_always_highinc =</span> <span class="dv">0</span>,</span>
<span id="cb18-14"><a href="#cb18-14"></a>    <span class="at">b_rarely_service_worker =</span> <span class="dv">0</span>,</span>
<span id="cb18-15"><a href="#cb18-15"></a>    <span class="at">b_often_service_worker =</span> <span class="dv">0</span>,</span>
<span id="cb18-16"><a href="#cb18-16"></a>    <span class="at">b_always_service_worker =</span> <span class="dv">0</span></span>
<span id="cb18-17"><a href="#cb18-17"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="covidfuture-wfh-mnl.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-19_4c414ff5c701503ba382873d0627de80">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>apollo_fixed <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb19-2"><a href="#cb19-2"></a></span>
<span id="cb19-3"><a href="#cb19-3"></a>apollo_inputs <span class="ot">=</span> <span class="fu">apollo_validateInputs</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>All checks on apollo_control completed.
All checks on database completed.</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="covidfuture-wfh-mnl.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-20_e278037bc92e3c3144023ad892f2fb39">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="co"># Finally, we define the utility functions in apollo_probabilities</span></span>
<span id="cb21-2"><a href="#cb21-2"></a>apollo_probabilities <span class="ot">=</span> <span class="cf">function</span>(apollo_beta, apollo_inputs,</span>
<span id="cb21-3"><a href="#cb21-3"></a>        <span class="at">functionality=</span><span class="st">"estimate"</span>) {</span>
<span id="cb21-4"><a href="#cb21-4"></a>    <span class="fu">apollo_attach</span>(apollo_beta, apollo_inputs)</span>
<span id="cb21-5"><a href="#cb21-5"></a>    <span class="fu">on.exit</span>(<span class="fu">apollo_detach</span>(apollo_beta, apollo_inputs))</span>
<span id="cb21-6"><a href="#cb21-6"></a></span>
<span id="cb21-7"><a href="#cb21-7"></a>    P <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb21-8"><a href="#cb21-8"></a></span>
<span id="cb21-9"><a href="#cb21-9"></a>    <span class="co"># define utility functions</span></span>
<span id="cb21-10"><a href="#cb21-10"></a>    V <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb21-11"><a href="#cb21-11"></a>    <span class="co"># fix one utility to zero</span></span>
<span id="cb21-12"><a href="#cb21-12"></a>    V[[<span class="st">"Unable"</span>]] <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb21-13"><a href="#cb21-13"></a>    V[[<span class="st">"Rarely"</span>]] <span class="ot">=</span> asc_rarely <span class="sc">+</span> b_rarely_age <span class="sc">*</span> age <span class="sc">+</span></span>
<span id="cb21-14"><a href="#cb21-14"></a>        b_rarely_highinc <span class="sc">*</span> income_100k_plus <span class="sc">+</span></span>
<span id="cb21-15"><a href="#cb21-15"></a>        b_rarely_service_worker <span class="sc">*</span> service_worker</span>
<span id="cb21-16"><a href="#cb21-16"></a>    V[[<span class="st">"Often"</span>]] <span class="ot">=</span> asc_often <span class="sc">+</span> b_often_age <span class="sc">*</span> age <span class="sc">+</span></span>
<span id="cb21-17"><a href="#cb21-17"></a>        b_often_highinc <span class="sc">*</span> income_100k_plus <span class="sc">+</span></span>
<span id="cb21-18"><a href="#cb21-18"></a>        b_often_service_worker <span class="sc">*</span> service_worker</span>
<span id="cb21-19"><a href="#cb21-19"></a>    V[[<span class="st">"Always"</span>]] <span class="ot">=</span> asc_always <span class="sc">+</span> b_always_age <span class="sc">*</span> age <span class="sc">+</span></span>
<span id="cb21-20"><a href="#cb21-20"></a>        b_always_highinc <span class="sc">*</span> income_100k_plus <span class="sc">+</span></span>
<span id="cb21-21"><a href="#cb21-21"></a>        b_always_service_worker <span class="sc">*</span> service_worker</span>
<span id="cb21-22"><a href="#cb21-22"></a>        </span>
<span id="cb21-23"><a href="#cb21-23"></a>    mnl_settings <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb21-24"><a href="#cb21-24"></a>        <span class="at">alternatives =</span> <span class="fu">c</span>(<span class="at">Unable=</span><span class="st">"Unable"</span>, <span class="at">Rarely=</span><span class="st">"Rarely"</span>,</span>
<span id="cb21-25"><a href="#cb21-25"></a>            <span class="at">Often=</span><span class="st">"Often"</span>, <span class="at">Always=</span><span class="st">"Always"</span>),</span>
<span id="cb21-26"><a href="#cb21-26"></a>        <span class="at">avail =</span> <span class="fu">list</span>(<span class="at">Unable=</span>T, <span class="at">Rarely=</span>T, <span class="at">Often=</span>T, <span class="at">Always=</span>T),</span>
<span id="cb21-27"><a href="#cb21-27"></a>        <span class="at">choiceVar =</span> wfh,</span>
<span id="cb21-28"><a href="#cb21-28"></a>        <span class="at">utilities =</span> V</span>
<span id="cb21-29"><a href="#cb21-29"></a>    )</span>
<span id="cb21-30"><a href="#cb21-30"></a></span>
<span id="cb21-31"><a href="#cb21-31"></a>    P[[<span class="st">"model"</span>]] <span class="ot">=</span> <span class="fu">apollo_mnl</span>(mnl_settings, functionality)</span>
<span id="cb21-32"><a href="#cb21-32"></a>    P <span class="ot">=</span> <span class="fu">apollo_prepareProb</span>(P, apollo_inputs, functionality)</span>
<span id="cb21-33"><a href="#cb21-33"></a>    <span class="fu">return</span>(P)</span>
<span id="cb21-34"><a href="#cb21-34"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="covidfuture-wfh-mnl.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-21_f1e0c3cc8b8738877068f80533371a6e">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="co"># estimate model</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>model <span class="ot">=</span> <span class="fu">apollo_estimate</span>(apollo_beta, apollo_fixed,</span>
<span id="cb22-3"><a href="#cb22-3"></a>    apollo_probabilities, apollo_inputs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Preparing user-defined functions.

Testing likelihood function...

Overview of choices for MNL model component :
                                  Unable  Rarely  Often  Always
Times available                  4895.00 4895.00 4895.0 4895.00
Times chosen                     2386.00  228.00 1640.0  641.00
Percentage chosen overall          48.74    4.66   33.5   13.09
Percentage chosen when available   48.74    4.66   33.5   13.09

Pre-processing likelihood function...

Testing influence of parameters
Starting main estimation
Initial function value: -6785.911 
Initial gradient value:
             asc_rarely               asc_often              asc_always 
                -995.75                  416.25                 -582.75 
           b_rarely_age             b_often_age            b_always_age 
              -45652.00                16701.00               -23413.00 
       b_rarely_highinc         b_often_highinc        b_always_highinc 
                -361.50                  380.50                 -183.50 
b_rarely_service_worker  b_often_service_worker b_always_service_worker 
                -493.25                  -56.25                 -415.25 
initial  value 6785.910898 
iter   2 value 6028.442633
iter   3 value 5685.432004
iter   4 value 5679.055816
iter   5 value 5394.755990
iter   6 value 5278.692311
iter   7 value 5263.035019
iter   8 value 5258.497397
iter   9 value 5248.299040
iter  10 value 5221.159849
iter  11 value 5173.585242
iter  12 value 5125.560646
iter  13 value 5111.633098
iter  14 value 5106.523896
iter  15 value 5082.704875
iter  16 value 5079.556757
iter  17 value 5078.866308
iter  18 value 5078.706760
iter  19 value 5078.698911
iter  20 value 5078.698753
iter  20 value 5078.698750
iter  20 value 5078.698749
final  value 5078.698749 
converged
Additional convergence test using scaled estimation. Parameters will be
  scaled by their current estimates and additional iterations will be
  performed.
initial  value 5078.698749 
iter   1 value 5078.698749
final  value 5078.698749 
converged
Estimated parameters:
                           Estimate
asc_rarely                 -0.72861
asc_often                   0.50458
asc_always                 -1.36727
b_rarely_age               -0.03318
b_often_age                -0.01467
b_always_age                0.01224
b_rarely_highinc            0.81208
b_often_highinc             1.01227
b_always_highinc            0.53411
b_rarely_service_worker    -0.93900
b_often_service_worker     -1.26770
b_always_service_worker    -1.54383

Computing covariance matrix using analytical gradient.
 0%....25%....50%....75%....100%
Negative definite Hessian with maximum eigenvalue: -16.466841
Computing score matrix...
Calculating LL(0) for applicable models...
Calculating LL(c) for applicable models...
Calculating LL of each model component...</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="covidfuture-wfh-mnl.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-22_d3aecc5a1ad16b53352f211be47fda19">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="co"># Print results</span></span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="fu">apollo_modelOutput</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model run by mwbc using Apollo 0.2.7 on R 4.2.1 for Darwin.
www.ApolloChoiceModelling.com

Model name                       : WFH_Postpandemic
Model description                : No model description provided in apollo_control
Model run at                     : 2022-08-10 12:28:23
Estimation method                : bfgs
Model diagnosis                  : successful convergence 
Number of individuals            : 4895
Number of rows in database       : 4895
Number of modelled outcomes      : 4895

Number of cores used             :  1 
Model without mixing

LL(start)                        : -6785.91
LL(0)                            : -6785.91
LL(C)                            : -5510.24
LL(final)                        : -5078.7
Rho-square (0)                   :  0.2516 
Adj.Rho-square (0)               :  0.2498 
Rho-square (C)                   :  0.0783 
Adj.Rho-square (C)               :  0.0761 
AIC                              :  10181.4 
BIC                              :  10259.35 

Estimated parameters             :  12
Time taken (hh:mm:ss)            :  00:00:0.7 
     pre-estimation              :  00:00:0.26 
     estimation                  :  00:00:0.14 
     post-estimation             :  00:00:0.3 
Iterations                       :  24  
Min abs eigenvalue of Hessian    :  16.46684 

Unconstrained optimisation.

Estimates:
                           Estimate        s.e.   t.rat.(0)    Rob.s.e.
asc_rarely                 -0.72861    0.231197      -3.151    0.234610
asc_often                   0.50458    0.116246       4.341    0.118378
asc_always                 -1.36727    0.163257      -8.375    0.158789
b_rarely_age               -0.03318    0.005224      -6.351    0.005380
b_often_age                -0.01467    0.002391      -6.135    0.002418
b_always_age                0.01224    0.003156       3.880    0.003086
b_rarely_highinc            0.81208    0.147684       5.499    0.144518
b_often_highinc             1.01227    0.072260      14.009    0.071662
b_always_highinc            0.53411    0.096440       5.538    0.095423
b_rarely_service_worker    -0.93900    0.143583      -6.540    0.141024
b_often_service_worker     -1.26770    0.069906     -18.134    0.069960
b_always_service_worker    -1.54383    0.099610     -15.499    0.099288
                        Rob.t.rat.(0)
asc_rarely                     -3.106
asc_often                       4.262
asc_always                     -8.611
b_rarely_age                   -6.168
b_often_age                    -6.066
b_always_age                    3.968
b_rarely_highinc                5.619
b_often_highinc                14.126
b_always_highinc                5.597
b_rarely_service_worker        -6.658
b_often_service_worker        -18.120
b_always_service_worker       -15.549</code></pre>
</div>
</div>
</section>
<section id="interpreting-multinomial-logit-results" class="slide level2">
<h2>Interpreting multinomial logit results</h2>
<div class="cell" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-23_22494bddf8dbaa280eb13cb33a906c17">
<div class="cell-output-display">
<table>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">Rarely</th>
<th style="text-align: right;">Often</th>
<th style="text-align: right;">Always</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">ASC</td>
<td style="text-align: right;">-0.73</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">-1.37</td>
</tr>
<tr class="even">
<td style="text-align: left;">Age</td>
<td style="text-align: right;">-0.03</td>
<td style="text-align: right;">-0.01</td>
<td style="text-align: right;">0.01</td>
</tr>
<tr class="odd">
<td style="text-align: left;">High income</td>
<td style="text-align: right;">0.81</td>
<td style="text-align: right;">1.01</td>
<td style="text-align: right;">0.53</td>
</tr>
<tr class="even">
<td style="text-align: left;">Service worker</td>
<td style="text-align: right;">-0.94</td>
<td style="text-align: right;">-1.27</td>
<td style="text-align: right;">-1.54</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Note: all variables significant at <span class="math inline">\(p &lt; 0.05\)</span></p>
</section>
<section class="slide level2">

<ul>
<li>Relative to being unable to WFH,
<ul>
<li>Older people are less likely to WFH rarely or often, but more likely to always</li>
<li>Higher income people are much more likely to be able to and choose to WFH</li>
<li>Service workers are less likely to be able to WFH</li>
<li>Scale of age variable is different from others</li>
</ul></li>
</ul>
</section>
<section id="questions-1" class="slide level2">
<h2>Questions?</h2>
</section>
<section id="specifying-a-multinomial-logit-model" class="slide level2">
<h2>Specifying a multinomial logit model</h2>
<ul>
<li>Multinomial logit models can have independent variables that vary at the individual level (e.g., income)</li>
<li>Can also have variables at the alternative level (e.g., travel time)</li>
<li>Utilities identified only up to a constant offset
<ul>
<li>Constant changes to all utilities does not change outcome</li>
</ul></li>
</ul>
</section>
<section id="specifying-a-multinomial-logit-model-1" class="slide level2">
<h2>Specifying a multinomial logit model</h2>
<ul>
<li>Variables that vary at <em>individual</em> level must have different coefficients for each alternative, and one must be zero</li>
<li>Variables that vary at <em>alternative</em> level may or may not have different coefficients for each alternative, and there is no need have one zero coefficient
<ul>
<li>But you do have to know values for unchosen alternatives</li>
</ul></li>
</ul>
</section>
<section id="specifying-a-multinomial-logit-model-2" class="slide level2">
<h2>Specifying a multinomial logit model</h2>
<div class="cell" data-fig-width="12" data-fig-height="6">
<div class="cell-output-display">
<div>
<p>
<svg width="1152" height="576" viewbox="0.00 0.00 616.11 169.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style=" display: block; margin: auto auto auto auto">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 165)">
<title>
G
</title>
<polygon fill="transparent" stroke="transparent" points="-4,4 -4,-165 612.11,-165 612.11,4 -4,4"></polygon> <g id="clust1" class="cluster">
<title>
clustertt
</title>
<polygon fill="transparent" stroke="transparent" points="112.35,-101 112.35,-153 527.35,-153 527.35,-101 112.35,-101"></polygon> </g> <!-- inc --> <g id="node1" class="node">
<title>
inc
</title>
<polygon fill="none" stroke="#ffffff" points="100.33,-145 42.37,-145 42.37,-109 100.33,-109 100.33,-145"></polygon> <text text-anchor="middle" x="71.35" y="-122.8" font-family="Times,serif" font-size="14.00" fill="#ffffff">Income</text> </g> <!-- iw --> <g id="node8" class="node">
<title>
iw
</title>
</g> <!-- inc&#45;&gt;iw --> <g id="edge1" class="edge">
<title>
inc-&gt;iw
</title>
<path fill="none" stroke="#ffffff" d="M65.23,-108.94C59.85,-93.93 52.8,-74.27 52.37,-73.06"></path> </g> <!-- ib --> <g id="node9" class="node">
<title>
ib
</title>
</g> <!-- inc&#45;&gt;ib --> <g id="edge2" class="edge">
<title>
inc-&gt;ib
</title>
<path fill="none" stroke="#ffffff" d="M77.46,-108.94C82.84,-93.93 89.89,-74.27 90.33,-73.06"></path> </g> <!-- ic --> <g id="node10" class="node">
<title>
ic
</title>
</g> <!-- inc&#45;&gt;ic --> <g id="edge3" class="edge">
<title>
inc-&gt;ic
</title>
<path fill="none" stroke="#ffffff" d="M71.35,-108.94C71.35,-93.93 71.35,-74.27 71.35,-73.06"></path> </g> <!-- ttw --> <g id="node2" class="node">
<title>
ttw
</title>
<polygon fill="none" stroke="#ffffff" points="246.64,-145 120.06,-145 120.06,-109 246.64,-109 246.64,-145"></polygon> <text text-anchor="middle" x="183.35" y="-122.8" font-family="Times,serif" font-size="14.00" fill="#ffffff">Travel time of walk</text> </g> <!-- tw --> <g id="node11" class="node">
<title>
tw
</title>
</g> <!-- ttw&#45;&gt;tw --> <g id="edge4" class="edge">
<title>
ttw-&gt;tw
</title>
<path fill="none" stroke="#ffffff" d="M184.31,-108.94C185.16,-93.93 186.27,-74.27 186.34,-73.06"></path> </g> <!-- ttb --> <g id="node3" class="node">
<title>
ttb
</title>
<polygon fill="none" stroke="#ffffff" points="518.87,-145 399.82,-145 399.82,-109 518.87,-109 518.87,-145"></polygon> <text text-anchor="middle" x="459.35" y="-122.8" font-family="Times,serif" font-size="14.00" fill="#ffffff">Travel time of bus</text> </g> <!-- tb --> <g id="node12" class="node">
<title>
tb
</title>
</g> <!-- ttb&#45;&gt;tb --> <g id="edge5" class="edge">
<title>
ttb-&gt;tb
</title>
<path fill="none" stroke="#ffffff" d="M464.18,-108.94C468.42,-93.93 473.99,-74.27 474.33,-73.06"></path> </g> <!-- ttc --> <g id="node4" class="node">
<title>
ttc
</title>
<polygon fill="none" stroke="#ffffff" points="381.51,-145 265.18,-145 265.18,-109 381.51,-109 381.51,-145"></polygon> <text text-anchor="middle" x="323.35" y="-122.8" font-family="Times,serif" font-size="14.00" fill="#ffffff">Travel time of car</text> </g> <!-- tc --> <g id="node13" class="node">
<title>
tc
</title>
</g> <!-- ttc&#45;&gt;tc --> <g id="edge6" class="edge">
<title>
ttc-&gt;tc
</title>
<path fill="none" stroke="#ffffff" d="M326.57,-108.94C329.4,-93.93 333.11,-74.27 333.34,-73.06"></path> </g> <!-- uw --> <g id="node5" class="node">
<title>
uw
</title>
<ellipse fill="none" stroke="#ffffff" cx="186.35" cy="-18" rx="67.8" ry="18"></ellipse> <text text-anchor="middle" x="186.35" y="-13.8" font-family="Times,serif" font-size="14.00" fill="#ffffff">Utility of walk</text> </g> <!-- ub --> <g id="node6" class="node">
<title>
ub
</title>
<ellipse fill="none" stroke="#ffffff" cx="474.35" cy="-18" rx="62.58" ry="18"></ellipse> <text text-anchor="middle" x="474.35" y="-13.8" font-family="Times,serif" font-size="14.00" fill="#ffffff">Utility of bus</text> </g> <!-- uc --> <g id="node7" class="node">
<title>
uc
</title>
<ellipse fill="none" stroke="#ffffff" cx="333.35" cy="-18" rx="60.83" ry="18"></ellipse> <text text-anchor="middle" x="333.35" y="-13.8" font-family="Times,serif" font-size="14.00" fill="#ffffff">Utility of car</text> </g> <!-- iw&#45;&gt;uw --> <g id="edge7" class="edge">
<title>
iw-&gt;uw
</title>
<path fill="none" stroke="#ffffff" d="M52.44,-71.96C54.88,-71 102.82,-52.04 140.64,-37.08"></path> <polygon fill="#ffffff" stroke="#ffffff" points="142,-40.31 150.01,-33.37 139.42,-33.8 142,-40.31"></polygon> </g> <!-- md --> <g id="node14" class="node">
<title>
md
</title>
<text text-anchor="middle" x="50.35" y="-22.2" font-family="Times,serif" font-size="14.00" fill="#ff0948">Must be different,</text> <text text-anchor="middle" x="50.35" y="-5.4" font-family="Times,serif" font-size="14.00" fill="#ff0948">one must be zero</text> </g> <!-- iw&#45;&gt;md --> <g id="edge13" class="edge">
<title>
iw-&gt;md
</title>
<path fill="none" stroke="#ff0948" d="M52.34,-71.85C52.27,-69.89 51.5,-49.49 50.94,-34.62"></path> </g> <!-- ib&#45;&gt;ub --> <g id="edge8" class="edge">
<title>
ib-&gt;ub
</title>
<path fill="none" stroke="#ffffff" d="M90.47,-71.99C95.81,-71.63 267.61,-59.97 403.35,-36 408.65,-35.06 414.15,-33.97 419.64,-32.8"></path> <polygon fill="#ffffff" stroke="#ffffff" points="420.44,-36.2 429.45,-30.61 418.92,-29.37 420.44,-36.2"></polygon> </g> <!-- ib&#45;&gt;md --> <g id="edge15" class="edge">
<title>
ib-&gt;md
</title>
<path fill="none" stroke="#ff0948" d="M90.23,-71.85C88.76,-69.89 73.36,-49.49 62.14,-34.62"></path> </g> <!-- ic&#45;&gt;uc --> <g id="edge9" class="edge">
<title>
ic-&gt;uc
</title>
<path fill="none" stroke="#ffffff" d="M71.42,-71.99C74.69,-71.45 179.79,-53.97 263.35,-36 268.34,-34.93 273.52,-33.76 278.7,-32.57"></path> <polygon fill="#ffffff" stroke="#ffffff" points="279.68,-35.93 288.62,-30.24 278.08,-29.12 279.68,-35.93"></polygon> </g> <!-- ic&#45;&gt;md --> <g id="edge14" class="edge">
<title>
ic-&gt;md
</title>
<path fill="none" stroke="#ff0948" d="M71.29,-71.85C70.51,-69.89 62.43,-49.49 56.54,-34.62"></path> </g> <!-- tw&#45;&gt;uw --> <g id="edge10" class="edge">
<title>
tw-&gt;uw
</title>
<path fill="none" stroke="#ffffff" d="M186.35,-71.85C186.35,-70.37 186.35,-58.32 186.35,-46.1"></path> <polygon fill="#ffffff" stroke="#ffffff" points="189.85,-46.02 186.35,-36.02 182.85,-46.02 189.85,-46.02"></polygon> </g> <!-- tb&#45;&gt;ub --> <g id="edge11" class="edge">
<title>
tb-&gt;ub
</title>
<path fill="none" stroke="#ffffff" d="M474.35,-71.85C474.35,-70.37 474.35,-58.32 474.35,-46.1"></path> <polygon fill="#ffffff" stroke="#ffffff" points="477.85,-46.02 474.35,-36.02 470.85,-46.02 477.85,-46.02"></polygon> </g> <!-- tc&#45;&gt;uc --> <g id="edge12" class="edge">
<title>
tc-&gt;uc
</title>
<path fill="none" stroke="#ffffff" d="M333.35,-71.85C333.35,-70.37 333.35,-58.32 333.35,-46.1"></path> <polygon fill="#ffffff" stroke="#ffffff" points="336.85,-46.02 333.35,-36.02 329.85,-46.02 336.85,-46.02"></polygon> </g> <!-- cs --> <g id="node15" class="node">
<title>
cs
</title>
<text text-anchor="middle" x="572.35" y="-122.8" font-family="Times,serif" font-size="14.00" fill="#ff0948">Can be same</text> </g> <!-- cs&#45;&gt;tw --> <g id="edge16" class="edge">
<title>
cs-&gt;tw
</title>
<path fill="none" stroke="#ff0948" d="M563.2,-118.68C555.27,-112.78 543.24,-104.87 531.35,-101 458.77,-77.41 190.58,-73.07 186.4,-73"></path> </g> <!-- cs&#45;&gt;tb --> <g id="edge17" class="edge">
<title>
cs-&gt;tb
</title>
<path fill="none" stroke="#ff0948" d="M560.67,-118.49C552.56,-113.37 541.43,-106.54 531.35,-101 507.38,-87.84 476.36,-73.9 474.44,-73.04"></path> </g> <!-- cs&#45;&gt;tc --> <g id="edge18" class="edge">
<title>
cs-&gt;tc
</title>
<path fill="none" stroke="#ff0948" d="M562.81,-118.63C554.85,-112.87 542.96,-105.16 531.35,-101 451.6,-72.43 344,-72.88 334.09,-72.99"></path> </g> </g>
</svg>
</p>
</div>
</div>
</div>
</section>
<section id="estimating-a-multinomial-logit-model-in-r" class="slide level2">
<h2>Estimating a multinomial logit model in R</h2>
<div class="cell" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-25_29098c623adc6ffebfad6c5ce26e4025">

</div>
<ul>
<li>We’re going to build a multinomial logit mode choice model of intercity mode choice</li>
<li>Data from Apollo examples</li>
</ul>
</section>
<section id="the-data" class="slide level2">
<h2>The data</h2>
<div class="cell" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-26_41c7ea0bce2177d681763402086677ac">
<div class="cell-output-display">
<table>
<colgroup>
<col style="width: 1%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 5%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 5%">
<col style="width: 6%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 3%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">ID</th>
<th style="text-align: right;">av_car</th>
<th style="text-align: right;">av_bus</th>
<th style="text-align: right;">av_air</th>
<th style="text-align: right;">av_rail</th>
<th style="text-align: right;">time_car</th>
<th style="text-align: right;">cost_car</th>
<th style="text-align: right;">time_bus</th>
<th style="text-align: right;">cost_bus</th>
<th style="text-align: right;">access_bus</th>
<th style="text-align: right;">time_air</th>
<th style="text-align: right;">cost_air</th>
<th style="text-align: right;">access_air</th>
<th style="text-align: right;">service_air</th>
<th style="text-align: right;">time_rail</th>
<th style="text-align: right;">cost_rail</th>
<th style="text-align: right;">access_rail</th>
<th style="text-align: right;">service_rail</th>
<th style="text-align: right;">female</th>
<th style="text-align: right;">business</th>
<th style="text-align: right;">income</th>
<th style="text-align: right;">choice</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">50</td>
<td style="text-align: right;">80</td>
<td style="text-align: right;">55</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">140</td>
<td style="text-align: right;">55</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">46705</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">70</td>
<td style="text-align: right;">80</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">170</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">46705</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">345</td>
<td style="text-align: right;">40</td>
<td style="text-align: right;">345</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">130</td>
<td style="text-align: right;">55</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">50123</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">345</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">345</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">130</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">50123</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">65</td>
<td style="text-align: right;">40</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">130</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">67589</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">60</td>
<td style="text-align: right;">110</td>
<td style="text-align: right;">40</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">170</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">67589</td>
<td style="text-align: right;">4</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="estimation-in-r" class="slide level2">
<h2>Estimation in R</h2>
<p><code>mode-choice-mnl.R</code></p>
<div class="cell" data-filename="mode-choice-mnl.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-28_ebfff9d328756b15f8371886811af2da">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="fu">library</span>(apollo)</span>
<span id="cb26-2"><a href="#cb26-2"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb26-3"><a href="#cb26-3"></a></span>
<span id="cb26-4"><a href="#cb26-4"></a>database <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="st">"data/modechoice_apollo.csv"</span>)</span>
<span id="cb26-5"><a href="#cb26-5"></a></span>
<span id="cb26-6"><a href="#cb26-6"></a><span class="fu">apollo_initialise</span>()</span>
<span id="cb26-7"><a href="#cb26-7"></a></span>
<span id="cb26-8"><a href="#cb26-8"></a>apollo_control <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb26-9"><a href="#cb26-9"></a>    <span class="at">modelName =</span> <span class="st">"Apollo_Mode_Choice"</span>,</span>
<span id="cb26-10"><a href="#cb26-10"></a>    <span class="at">indivID=</span><span class="st">"ID"</span></span>
<span id="cb26-11"><a href="#cb26-11"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="mode-choice-mnl.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-29_f9165a440c74cb29d19a42855dc993c3">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="fu">head</span>(database)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 22
     ID av_car av_bus av_air av_rail time_car cost_car time_bus cost_bus acces…¹
  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;
1     1      0      0      1       1        0        0        0        0       0
2     1      0      0      1       1        0        0        0        0       0
3     2      1      1      0       1      345       40      345       30      15
4     2      1      1      0       1      345       45      345       25      20
5     3      0      0      1       1        0        0        0        0       0
6     3      0      0      1       1        0        0        0        0       0
# … with 12 more variables: time_air &lt;dbl&gt;, cost_air &lt;dbl&gt;, access_air &lt;dbl&gt;,
#   service_air &lt;dbl&gt;, time_rail &lt;dbl&gt;, cost_rail &lt;dbl&gt;, access_rail &lt;dbl&gt;,
#   service_rail &lt;dbl&gt;, female &lt;dbl&gt;, business &lt;dbl&gt;, income &lt;dbl&gt;,
#   choice &lt;dbl&gt;, and abbreviated variable name ¹​access_bus
# ℹ Use `colnames()` to see all variable names</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="mode-choice-mnl.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-30_d6fb1b1521f9105ded9e047e3971e45f">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a>apollo_beta <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb29-2"><a href="#cb29-2"></a>    <span class="at">asc_air =</span> <span class="dv">0</span>,</span>
<span id="cb29-3"><a href="#cb29-3"></a>    <span class="at">asc_bus =</span> <span class="dv">0</span>,</span>
<span id="cb29-4"><a href="#cb29-4"></a>    <span class="at">asc_rail =</span> <span class="dv">0</span>,</span>
<span id="cb29-5"><a href="#cb29-5"></a>    <span class="co"># leaving out an asc_car as base category</span></span>
<span id="cb29-6"><a href="#cb29-6"></a>    <span class="at">b_cost =</span> <span class="dv">0</span>,</span>
<span id="cb29-7"><a href="#cb29-7"></a>    <span class="at">b_access_time =</span> <span class="dv">0</span>,</span>
<span id="cb29-8"><a href="#cb29-8"></a>    <span class="at">b_in_vehicle_time =</span> <span class="dv">0</span>,</span>
<span id="cb29-9"><a href="#cb29-9"></a>    <span class="co"># income is an individual level variable, so</span></span>
<span id="cb29-10"><a href="#cb29-10"></a>    <span class="co"># must be different for different alternatives</span></span>
<span id="cb29-11"><a href="#cb29-11"></a>    <span class="at">b_income_air =</span> <span class="dv">0</span>,</span>
<span id="cb29-12"><a href="#cb29-12"></a>    <span class="at">b_income_bus =</span> <span class="dv">0</span>,</span>
<span id="cb29-13"><a href="#cb29-13"></a>    <span class="at">b_income_rail =</span> <span class="dv">0</span></span>
<span id="cb29-14"><a href="#cb29-14"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="mode-choice-mnl.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-31_1d461819ab8278daddfc92716458c0b1">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>apollo_fixed <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb30-2"><a href="#cb30-2"></a></span>
<span id="cb30-3"><a href="#cb30-3"></a>apollo_inputs <span class="ot">=</span> <span class="fu">apollo_validateInputs</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Several observations per individual detected based on the value of ID.
  Setting panelData in apollo_control set to TRUE.
All checks on apollo_control completed.
All checks on database completed.</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="mode-choice-mnl.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-32_2b9a32514be0d30d4bbce487ab326f3e">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>apollo_probabilities <span class="ot">=</span> <span class="cf">function</span>(apollo_beta, apollo_inputs,</span>
<span id="cb32-2"><a href="#cb32-2"></a>        <span class="at">functionality=</span><span class="st">"estimate"</span>) {</span>
<span id="cb32-3"><a href="#cb32-3"></a>    <span class="fu">apollo_attach</span>(apollo_beta, apollo_inputs)</span>
<span id="cb32-4"><a href="#cb32-4"></a>    <span class="fu">on.exit</span>(<span class="fu">apollo_detach</span>(apollo_beta, apollo_inputs))</span>
<span id="cb32-5"><a href="#cb32-5"></a></span>
<span id="cb32-6"><a href="#cb32-6"></a>    P <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb32-7"><a href="#cb32-7"></a></span>
<span id="cb32-8"><a href="#cb32-8"></a>    <span class="co"># define utility functions</span></span>
<span id="cb32-9"><a href="#cb32-9"></a>    V <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb32-10"><a href="#cb32-10"></a>    <span class="co"># We can include cost and in-vehicle time here because they vary over</span></span>
<span id="cb32-11"><a href="#cb32-11"></a>    <span class="co"># alternatives</span></span>
<span id="cb32-12"><a href="#cb32-12"></a>    V[[<span class="st">"car"</span>]] <span class="ot">=</span> b_cost <span class="sc">*</span> cost_car <span class="sc">+</span></span>
<span id="cb32-13"><a href="#cb32-13"></a>        b_in_vehicle_time <span class="sc">*</span> time_car</span>
<span id="cb32-14"><a href="#cb32-14"></a></span>
<span id="cb32-15"><a href="#cb32-15"></a>    V[[<span class="st">"air"</span>]] <span class="ot">=</span> asc_air <span class="sc">+</span></span>
<span id="cb32-16"><a href="#cb32-16"></a>        b_cost <span class="sc">*</span> cost_air <span class="sc">+</span></span>
<span id="cb32-17"><a href="#cb32-17"></a>        b_in_vehicle_time <span class="sc">*</span> time_air <span class="sc">+</span></span>
<span id="cb32-18"><a href="#cb32-18"></a>        b_access_time <span class="sc">*</span> access_air <span class="sc">+</span></span>
<span id="cb32-19"><a href="#cb32-19"></a>        b_income_air <span class="sc">*</span> income</span>
<span id="cb32-20"><a href="#cb32-20"></a></span>
<span id="cb32-21"><a href="#cb32-21"></a>    V[[<span class="st">"rail"</span>]] <span class="ot">=</span> asc_rail <span class="sc">+</span></span>
<span id="cb32-22"><a href="#cb32-22"></a>        b_cost <span class="sc">*</span> cost_rail <span class="sc">+</span></span>
<span id="cb32-23"><a href="#cb32-23"></a>        b_in_vehicle_time <span class="sc">*</span> time_rail <span class="sc">+</span></span>
<span id="cb32-24"><a href="#cb32-24"></a>        b_access_time <span class="sc">*</span> access_rail <span class="sc">+</span></span>
<span id="cb32-25"><a href="#cb32-25"></a>        b_income_rail <span class="sc">*</span> income</span>
<span id="cb32-26"><a href="#cb32-26"></a></span>
<span id="cb32-27"><a href="#cb32-27"></a>    V[[<span class="st">"bus"</span>]] <span class="ot">=</span> asc_bus <span class="sc">+</span></span>
<span id="cb32-28"><a href="#cb32-28"></a>        b_cost <span class="sc">*</span> cost_bus <span class="sc">+</span></span>
<span id="cb32-29"><a href="#cb32-29"></a>        b_in_vehicle_time <span class="sc">*</span> time_bus <span class="sc">+</span></span>
<span id="cb32-30"><a href="#cb32-30"></a>        b_access_time <span class="sc">*</span> access_bus <span class="sc">+</span></span>
<span id="cb32-31"><a href="#cb32-31"></a>        b_income_bus <span class="sc">*</span> income</span>
<span id="cb32-32"><a href="#cb32-32"></a></span>
<span id="cb32-33"><a href="#cb32-33"></a>    mnl_settings <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb32-34"><a href="#cb32-34"></a>        <span class="at">alternatives =</span> <span class="fu">c</span>(<span class="at">car=</span><span class="dv">1</span>, <span class="at">air=</span><span class="dv">3</span>, <span class="at">rail=</span><span class="dv">4</span>, <span class="at">bus=</span><span class="dv">2</span>),</span>
<span id="cb32-35"><a href="#cb32-35"></a>        <span class="at">avail =</span> <span class="fu">list</span>(<span class="at">car=</span>av_car, <span class="at">air=</span>av_air, <span class="at">rail=</span>av_rail, <span class="at">bus=</span>av_bus),</span>
<span id="cb32-36"><a href="#cb32-36"></a>        <span class="at">choiceVar =</span> choice,</span>
<span id="cb32-37"><a href="#cb32-37"></a>        <span class="at">utilities =</span> V</span>
<span id="cb32-38"><a href="#cb32-38"></a>    )</span>
<span id="cb32-39"><a href="#cb32-39"></a></span>
<span id="cb32-40"><a href="#cb32-40"></a>    P[[<span class="st">"model"</span>]] <span class="ot">=</span> <span class="fu">apollo_mnl</span>(mnl_settings, functionality)</span>
<span id="cb32-41"><a href="#cb32-41"></a></span>
<span id="cb32-42"><a href="#cb32-42"></a>    <span class="co"># For panel data, this multiplies observations for single individuals</span></span>
<span id="cb32-43"><a href="#cb32-43"></a>    <span class="co"># together - no effect in multinomial logit but still required.</span></span>
<span id="cb32-44"><a href="#cb32-44"></a>    P <span class="ot">=</span> <span class="fu">apollo_panelProd</span>(P, apollo_inputs, functionality)</span>
<span id="cb32-45"><a href="#cb32-45"></a>    P <span class="ot">=</span> <span class="fu">apollo_prepareProb</span>(P, apollo_inputs, functionality)</span>
<span id="cb32-46"><a href="#cb32-46"></a>    <span class="fu">return</span>(P)</span>
<span id="cb32-47"><a href="#cb32-47"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="mode-choice-mnl.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-33_ffa5a34c2adadaa4f3b17f6196893753">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="co"># estimate model</span></span>
<span id="cb33-2"><a href="#cb33-2"></a>model <span class="ot">=</span> <span class="fu">apollo_estimate</span>(apollo_beta, apollo_fixed,</span>
<span id="cb33-3"><a href="#cb33-3"></a>    apollo_probabilities, apollo_inputs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Preparing user-defined functions.

Testing likelihood function...

Overview of choices for MNL model component :
                                    car    air   rail    bus
Times available                  778.00 752.00 874.00 902.00
Times chosen                     332.00 215.00 327.00 126.00
Percentage chosen overall         33.20  21.50  32.70  12.60
Percentage chosen when available  42.67  28.59  37.41  13.97

Pre-processing likelihood function...
Analytical gradient is different to numerical one. Numerical gradients
  will be used.

Testing influence of parameters.........
Starting main estimation
Initial function value: -1170.86 
Initial gradient value:
          asc_air           asc_bus          asc_rail            b_cost 
    -8.000002e+00     -1.536667e+02      5.966667e+01     -1.329167e+02 
    b_access_time b_in_vehicle_time      b_income_air      b_income_bus 
    -1.810417e+03     -1.898042e+04      3.114006e+05     -7.703172e+06 
    b_income_rail 
     2.710651e+06 
initial  value 1170.860076 
iter   2 value 1112.061643
iter   3 value 1098.117019
iter   4 value 1096.280213
iter   5 value 1088.850808
iter   6 value 1044.655722
iter   7 value 1043.621915
iter   8 value 1037.024630
iter   9 value 1027.797450
iter  10 value 1026.422719
iter  11 value 1021.845626
iter  12 value 1020.058229
iter  13 value 1020.002110
iter  14 value 1019.999301
iter  14 value 1019.999286
iter  14 value 1019.999286
final  value 1019.999286 
converged
Additional convergence test using scaled estimation. Parameters will be
  scaled by their current estimates and additional iterations will be
  performed.
initial  value 1019.999286 
iter   1 value 1019.999286
final  value 1019.999286 
converged
Estimated parameters:
                     Estimate
asc_air             -0.922580
asc_bus             -0.369843
asc_rail            -0.679845
b_cost              -0.032032
b_access_time       -0.006419
b_in_vehicle_time   -0.006126
b_income_air        1.045e-05
b_income_bus       -2.252e-05
b_income_rail       6.963e-07

Computing covariance matrix using numerical methods (numDeriv).
 0%....25%....50%....75%....100%
Negative definite Hessian with maximum eigenvalue: -3.070863
Computing score matrix...
Calculating LL(0) for applicable models...
Calculating LL(c) for applicable models...
Calculating LL of each model component...</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="mode-choice-mnl.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-34_96a32ef44c930ed91abb230fd63261fc">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a><span class="co"># Print results</span></span>
<span id="cb35-2"><a href="#cb35-2"></a><span class="fu">apollo_modelOutput</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model run by mwbc using Apollo 0.2.7 on R 4.2.1 for Darwin.
www.ApolloChoiceModelling.com

Model name                       : Apollo_Mode_Choice
Model description                : No model description provided in apollo_control
Model run at                     : 2022-08-10 12:28:24
Estimation method                : bfgs
Model diagnosis                  : successful convergence 
Number of individuals            : 500
Number of rows in database       : 1000
Number of modelled outcomes      : 1000

Number of cores used             :  1 
Model without mixing

LL(start)                        : -1170.86
LL(0)                            : -1170.86
LL(C)                            : -1085.14
LL(final)                        : -1020
Rho-square (0)                   :  0.1288 
Adj.Rho-square (0)               :  0.1212 
Rho-square (C)                   :  0.06 
Adj.Rho-square (C)               :  0.0517 
AIC                              :  2058 
BIC                              :  2102.17 

Estimated parameters             :  9
Time taken (hh:mm:ss)            :  00:00:0.67 
     pre-estimation              :  00:00:0.15 
     estimation                  :  00:00:0.28 
     post-estimation             :  00:00:0.24 
Iterations                       :  20  
Min abs eigenvalue of Hessian    :  3.070863 

Unconstrained optimisation.

Estimates:
                     Estimate        s.e.   t.rat.(0)    Rob.s.e. Rob.t.rat.(0)
asc_air             -0.922580    0.502076     -1.8375    0.497421       -1.8547
asc_bus             -0.369843    0.315033     -1.1740    0.306346       -1.2073
asc_rail            -0.679845    0.332292     -2.0459    0.342767       -1.9834
b_cost              -0.032032    0.003242     -9.8796    0.003168      -10.1112
b_access_time       -0.006419    0.005974     -1.0744    0.005835       -1.1001
b_in_vehicle_time   -0.006126    0.001295     -4.7290    0.001368       -4.4792
b_income_air        1.045e-05   5.899e-06      1.7707   6.025e-06        1.7338
b_income_bus       -2.252e-05   6.741e-06     -3.3408   6.534e-06       -3.4463
b_income_rail       6.963e-07   5.090e-06      0.1368   5.216e-06        0.1335</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="mode-choice-mnl.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-35_f4fa5d9343be990a4b1ba73ce0e3b848">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a><span class="co"># save results in current directory,</span></span>
<span id="cb37-2"><a href="#cb37-2"></a><span class="co"># using model name specified above</span></span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="fu">apollo_saveOutput</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model output saved to /Users/mwbc/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/teaching/odum-discrete/Apollo_Mode_Choice_output.txt 
Estimates saved to /Users/mwbc/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/teaching/odum-discrete/Apollo_Mode_Choice_estimates.csv 
Model object saved to /Users/mwbc/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/teaching/odum-discrete/Apollo_Mode_Choice.rds </code></pre>
</div>
</div>
</section>
<section id="valuation-using-discrete-choice-models" class="slide level2">
<h2>Valuation using discrete choice models</h2>
<ul>
<li>A common use for discrete choice models is to calculate willingness-to-pay</li>
<li>The linear-in-parameters utility function puts everything in terms of utility</li>
<li>If we have a cost parameter, we can use the model to put everything else in monetary units</li>
</ul>
</section>
<section id="valuation-using-discrete-choice-models-1" class="slide level2">
<h2>Valuation using discrete choice models</h2>
<ul>
<li>The coefficients of the model are how much of <code>x</code> one unit of utility is worth
<ul>
<li>i.e.&nbsp;partial derivatives of utility with respect to <code>x</code></li>
</ul></li>
<li>We want value of time, i.e.&nbsp;dollars / hour</li>
<li>Travel time coefficient is utility / minute</li>
<li>Cost coefficient is utility / dollar</li>
<li>If <span class="math inline">\(u\)</span> is utility, <span class="math inline">\(c\)</span> is cost, and <span class="math inline">\(t\)</span> is in-vehicle time, <span class="math inline">\(\frac{\beta_t}{\beta_{c}} = \frac{\frac{\delta u}{\delta t}}{\frac{\delta u}{\delta c}} = \frac{\delta c}{\delta t}\)</span></li>
</ul>
</section>
<section id="valuation-using-discrete-choice-models-2" class="slide level2">
<h2>Valuation using discrete choice models</h2>
<p><span class="math display">\[\beta_c = -0.032\]</span></p>
<p><span class="math display">\[\beta_t = -0.0061\]</span></p>
<p><span class="math display">\[ \frac{\beta_t}{\beta_c} = \frac{-0.0061}{-0.032} = {£0.191}/\mathrm{minute} = {£11.46}/\mathrm{hour} \]</span></p>
</section>
<section id="confidence-intervals-for-valuation" class="slide level2">
<h2>Confidence intervals for valuation</h2>
<ul>
<li>We can use the Delta method to calculate standard errors for combinations of parameters <span class="citation" data-cites="daly_estimating_2020">(<a href="#/ref-daly_estimating_2020" role="doc-biblioref" onclick="return false;">Daly, Hess, and Ortúzar 2020</a>)</span></li>
<li>Implemented in Apollo using <code>apollo_deltaMethod</code> function</li>
</ul>
</section>
<section class="slide level2">

<div class="cell" data-filename="mode-choice-mnl.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-37_8ffe9ad08e0dd0a11000d8f41cf0e773">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="fu">apollo_deltaMethod</span>(model, <span class="at">deltaMethod_settings=</span><span class="fu">list</span>(</span>
<span id="cb39-2"><a href="#cb39-2"></a>    <span class="at">expression=</span><span class="st">"b_in_vehicle_time * 60 / b_cost"</span></span>
<span id="cb39-3"><a href="#cb39-3"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running Delta method computation for user-defined function:

                      Expression   Value Robust s.e. Rob t-ratio (0)
 b_in_vehicle_time * 60 / b_cost 11.4745      2.4434             4.7</code></pre>
</div>
</div>
</section>
<section id="exercise" class="slide level2">
<h2>Exercise</h2>
<ul>
<li>People may value in-vehicle time differently on the train vs.&nbsp;plane vs.&nbsp;car vs.&nbsp;bus</li>
<li>Modify the model to estimate separate in-vehicle time coefficients for each mode, and calculate willingness-to-pay for each</li>
<li>(One) answer in mode-choice-mnl-in-vehicle-answers.R</li>
</ul>
</section>
<section id="solution" class="slide level2">
<h2>Solution</h2>
<div class="cell" data-filename="mode-choice-mnl-in-vehicle-answers.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-40_3890b06d7da389b4f8cacde73ac4e6e8">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>apollo_beta <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb41-2"><a href="#cb41-2"></a>    <span class="at">asc_air =</span> <span class="dv">0</span>,</span>
<span id="cb41-3"><a href="#cb41-3"></a>    <span class="at">asc_bus =</span> <span class="dv">0</span>,</span>
<span id="cb41-4"><a href="#cb41-4"></a>    <span class="at">asc_rail =</span> <span class="dv">0</span>,</span>
<span id="cb41-5"><a href="#cb41-5"></a>    <span class="co"># leaving out an asc_car as base category</span></span>
<span id="cb41-6"><a href="#cb41-6"></a>    <span class="at">b_cost =</span> <span class="dv">0</span>,</span>
<span id="cb41-7"><a href="#cb41-7"></a>    <span class="at">b_access_time =</span> <span class="dv">0</span>,</span>
<span id="cb41-8"><a href="#cb41-8"></a>    <span class="at">b_in_vehicle_time_air =</span> <span class="dv">0</span>,</span>
<span id="cb41-9"><a href="#cb41-9"></a>    <span class="at">b_in_vehicle_time_bus =</span> <span class="dv">0</span>,</span>
<span id="cb41-10"><a href="#cb41-10"></a>    <span class="at">b_in_vehicle_time_car =</span> <span class="dv">0</span>,</span>
<span id="cb41-11"><a href="#cb41-11"></a>    <span class="at">b_in_vehicle_time_rail =</span> <span class="dv">0</span>,</span>
<span id="cb41-12"><a href="#cb41-12"></a>    <span class="co"># income and party_size are individual level variable, so</span></span>
<span id="cb41-13"><a href="#cb41-13"></a>    <span class="co"># must be different for different alternatives</span></span>
<span id="cb41-14"><a href="#cb41-14"></a>    <span class="at">b_income_air =</span> <span class="dv">0</span>,</span>
<span id="cb41-15"><a href="#cb41-15"></a>    <span class="at">b_income_bus =</span> <span class="dv">0</span>,</span>
<span id="cb41-16"><a href="#cb41-16"></a>    <span class="at">b_income_rail =</span> <span class="dv">0</span></span>
<span id="cb41-17"><a href="#cb41-17"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="mode-choice-mnl-in-vehicle-answers.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-42_63ef7216601f774a45a33bd77e6514ee">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>apollo_probabilities <span class="ot">=</span> <span class="cf">function</span>(apollo_beta, apollo_inputs,</span>
<span id="cb42-2"><a href="#cb42-2"></a>        <span class="at">functionality=</span><span class="st">"estimate"</span>) {</span>
<span id="cb42-3"><a href="#cb42-3"></a>    <span class="fu">apollo_attach</span>(apollo_beta, apollo_inputs)</span>
<span id="cb42-4"><a href="#cb42-4"></a>    <span class="fu">on.exit</span>(<span class="fu">apollo_detach</span>(apollo_beta, apollo_inputs))</span>
<span id="cb42-5"><a href="#cb42-5"></a></span>
<span id="cb42-6"><a href="#cb42-6"></a>    P <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-7"><a href="#cb42-7"></a></span>
<span id="cb42-8"><a href="#cb42-8"></a>    <span class="co"># define utility functions</span></span>
<span id="cb42-9"><a href="#cb42-9"></a>    V <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-10"><a href="#cb42-10"></a>    <span class="co"># We can include cost and in-vehicle time here because they vary over</span></span>
<span id="cb42-11"><a href="#cb42-11"></a>    <span class="co"># alternatives</span></span>
<span id="cb42-12"><a href="#cb42-12"></a>    V[[<span class="st">"car"</span>]] <span class="ot">=</span> b_cost <span class="sc">*</span> cost_car <span class="sc">+</span></span>
<span id="cb42-13"><a href="#cb42-13"></a>        b_in_vehicle_time_car <span class="sc">*</span> time_car</span>
<span id="cb42-14"><a href="#cb42-14"></a></span>
<span id="cb42-15"><a href="#cb42-15"></a>    V[[<span class="st">"air"</span>]] <span class="ot">=</span> asc_air <span class="sc">+</span></span>
<span id="cb42-16"><a href="#cb42-16"></a>        b_cost <span class="sc">*</span> cost_air <span class="sc">+</span></span>
<span id="cb42-17"><a href="#cb42-17"></a>        b_in_vehicle_time_air <span class="sc">*</span> time_air <span class="sc">+</span></span>
<span id="cb42-18"><a href="#cb42-18"></a>        b_access_time <span class="sc">*</span> access_air <span class="sc">+</span></span>
<span id="cb42-19"><a href="#cb42-19"></a>        b_income_air <span class="sc">*</span> income</span>
<span id="cb42-20"><a href="#cb42-20"></a></span>
<span id="cb42-21"><a href="#cb42-21"></a>    V[[<span class="st">"rail"</span>]] <span class="ot">=</span> asc_rail <span class="sc">+</span></span>
<span id="cb42-22"><a href="#cb42-22"></a>        b_cost <span class="sc">*</span> cost_rail <span class="sc">+</span></span>
<span id="cb42-23"><a href="#cb42-23"></a>        b_in_vehicle_time_rail <span class="sc">*</span> time_rail <span class="sc">+</span></span>
<span id="cb42-24"><a href="#cb42-24"></a>        b_access_time <span class="sc">*</span> access_rail <span class="sc">+</span></span>
<span id="cb42-25"><a href="#cb42-25"></a>        b_income_rail <span class="sc">*</span> income</span>
<span id="cb42-26"><a href="#cb42-26"></a></span>
<span id="cb42-27"><a href="#cb42-27"></a>    V[[<span class="st">"bus"</span>]] <span class="ot">=</span> asc_bus <span class="sc">+</span></span>
<span id="cb42-28"><a href="#cb42-28"></a>        b_cost <span class="sc">*</span> cost_bus <span class="sc">+</span></span>
<span id="cb42-29"><a href="#cb42-29"></a>        b_in_vehicle_time_bus <span class="sc">*</span> time_bus <span class="sc">+</span></span>
<span id="cb42-30"><a href="#cb42-30"></a>        b_access_time <span class="sc">*</span> access_bus <span class="sc">+</span></span>
<span id="cb42-31"><a href="#cb42-31"></a>        b_income_bus <span class="sc">*</span> income</span>
<span id="cb42-32"><a href="#cb42-32"></a></span>
<span id="cb42-33"><a href="#cb42-33"></a>    mnl_settings <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb42-34"><a href="#cb42-34"></a>        <span class="at">alternatives =</span> <span class="fu">c</span>(<span class="at">car=</span><span class="dv">1</span>, <span class="at">air=</span><span class="dv">3</span>, <span class="at">rail=</span><span class="dv">4</span>, <span class="at">bus=</span><span class="dv">2</span>),</span>
<span id="cb42-35"><a href="#cb42-35"></a>        <span class="at">avail =</span> <span class="fu">list</span>(<span class="at">car=</span>av_car, <span class="at">air=</span>av_air, <span class="at">rail=</span>av_rail, <span class="at">bus=</span>av_bus),</span>
<span id="cb42-36"><a href="#cb42-36"></a>        <span class="at">choiceVar =</span> choice,</span>
<span id="cb42-37"><a href="#cb42-37"></a>        <span class="at">utilities =</span> V</span>
<span id="cb42-38"><a href="#cb42-38"></a>    )</span>
<span id="cb42-39"><a href="#cb42-39"></a></span>
<span id="cb42-40"><a href="#cb42-40"></a>    P[[<span class="st">"model"</span>]] <span class="ot">=</span> <span class="fu">apollo_mnl</span>(mnl_settings, functionality)</span>
<span id="cb42-41"><a href="#cb42-41"></a></span>
<span id="cb42-42"><a href="#cb42-42"></a>    <span class="co"># For panel data, this multiplies observations for single individuals</span></span>
<span id="cb42-43"><a href="#cb42-43"></a>    <span class="co"># together - no effect in multinomial logit but still required.</span></span>
<span id="cb42-44"><a href="#cb42-44"></a>    P <span class="ot">=</span> <span class="fu">apollo_panelProd</span>(P, apollo_inputs, functionality)</span>
<span id="cb42-45"><a href="#cb42-45"></a>    P <span class="ot">=</span> <span class="fu">apollo_prepareProb</span>(P, apollo_inputs, functionality)</span>
<span id="cb42-46"><a href="#cb42-46"></a>    <span class="fu">return</span>(P)</span>
<span id="cb42-47"><a href="#cb42-47"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="mode-choice-mnl-in-vehicle-answers.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-43_50a846a6d6255842b75a7fb8602c7f47">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a><span class="co"># estimate model</span></span>
<span id="cb43-2"><a href="#cb43-2"></a>model <span class="ot">=</span> <span class="fu">apollo_estimate</span>(apollo_beta, apollo_fixed,</span>
<span id="cb43-3"><a href="#cb43-3"></a>    apollo_probabilities, apollo_inputs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Preparing user-defined functions.

Testing likelihood function...

Overview of choices for MNL model component :
                                    car    air   rail    bus
Times available                  778.00 752.00 874.00 902.00
Times chosen                     332.00 215.00 327.00 126.00
Percentage chosen overall         33.20  21.50  32.70  12.60
Percentage chosen when available  42.67  28.59  37.41  13.97

Pre-processing likelihood function...
Analytical gradient is different to numerical one. Numerical gradients
  will be used.

Testing influence of parameters............
Starting main estimation
Initial function value: -1170.86 
Initial gradient value:
               asc_air                asc_bus               asc_rail 
         -8.000002e+00          -1.536667e+02           5.966667e+01 
                b_cost          b_access_time  b_in_vehicle_time_air 
         -1.329167e+02          -1.810417e+03          -6.925000e+02 
 b_in_vehicle_time_bus  b_in_vehicle_time_car b_in_vehicle_time_rail 
         -5.759500e+04           3.107750e+04           8.229583e+03 
          b_income_air           b_income_bus          b_income_rail 
          3.114006e+05          -7.703172e+06           2.710651e+06 
initial  value 1170.860076 
iter   2 value 1112.058599
iter   3 value 1098.115876
iter   4 value 1096.279422
iter   5 value 1088.042268
iter   6 value 1063.689936
iter   7 value 1054.903518
iter   8 value 1040.329195
iter   9 value 1037.028717
iter  10 value 1037.022155
iter  11 value 1016.930614
iter  12 value 1014.940892
iter  13 value 1014.780724
iter  14 value 1014.752777
iter  15 value 1014.741682
iter  16 value 1014.741571
iter  16 value 1014.741570
iter  16 value 1014.741570
final  value 1014.741570 
converged
Additional convergence test using scaled estimation. Parameters will be
  scaled by their current estimates and additional iterations will be
  performed.
initial  value 1014.741570 
iter   1 value 1014.741570
final  value 1014.741570 
converged
Estimated parameters:
                          Estimate
asc_air                   1.190584
asc_bus                   1.340214
asc_rail                  1.013686
b_cost                   -0.034030
b_access_time            -0.010182
b_in_vehicle_time_air    -0.020861
b_in_vehicle_time_bus    -0.008454
b_in_vehicle_time_car    -0.003488
b_in_vehicle_time_rail   -0.011478
b_income_air             9.912e-06
b_income_bus            -2.320e-05
b_income_rail           -8.098e-08

Computing covariance matrix using numerical methods (numDeriv).
 0%....25%....50%....75%....100%
Negative definite Hessian with maximum eigenvalue: -0.691575
Computing score matrix...
Calculating LL(0) for applicable models...
Calculating LL(c) for applicable models...
Calculating LL of each model component...</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="mode-choice-mnl-in-vehicle-answers.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-44_ccc5994d3b17dc39ea7994cda56b867f">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a><span class="co"># Print results</span></span>
<span id="cb45-2"><a href="#cb45-2"></a><span class="fu">apollo_modelOutput</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model run by mwbc using Apollo 0.2.7 on R 4.2.1 for Darwin.
www.ApolloChoiceModelling.com

Model name                       : Apollo_Mode_Choice_Flexible
Model description                : No model description provided in apollo_control
Model run at                     : 2022-08-10 12:28:25
Estimation method                : bfgs
Model diagnosis                  : successful convergence 
Number of individuals            : 500
Number of rows in database       : 1000
Number of modelled outcomes      : 1000

Number of cores used             :  1 
Model without mixing

LL(start)                        : -1170.86
LL(0)                            : -1170.86
LL(C)                            : -1085.14
LL(final)                        : -1014.74
Rho-square (0)                   :  0.1333 
Adj.Rho-square (0)               :  0.1231 
Rho-square (C)                   :  0.0649 
Adj.Rho-square (C)               :  0.0538 
AIC                              :  2053.48 
BIC                              :  2112.38 

Estimated parameters             :  12
Time taken (hh:mm:ss)            :  00:00:1.07 
     pre-estimation              :  00:00:0.18 
     estimation                  :  00:00:0.5 
     post-estimation             :  00:00:0.39 
Iterations                       :  22  
Min abs eigenvalue of Hessian    :  0.691575 

Unconstrained optimisation.

Estimates:
                          Estimate        s.e.   t.rat.(0)    Rob.s.e.
asc_air                   1.190584    0.883949     1.34689    0.877652
asc_bus                   1.340214    1.076607     1.24485    1.029324
asc_rail                  1.013686    0.847802     1.19566    0.848597
b_cost                   -0.034030    0.003328   -10.22497    0.003236
b_access_time            -0.010182    0.006467    -1.57448    0.006328
b_in_vehicle_time_air    -0.020861    0.006648    -3.13816    0.006544
b_in_vehicle_time_bus    -0.008454    0.002667    -3.16962    0.002636
b_in_vehicle_time_car    -0.003488    0.001560    -2.23642    0.001579
b_in_vehicle_time_rail   -0.011478    0.004394    -2.61200    0.004489
b_income_air             9.912e-06   5.908e-06     1.67774   5.970e-06
b_income_bus            -2.320e-05   6.763e-06    -3.43125   6.570e-06
b_income_rail           -8.098e-08   5.111e-06    -0.01585   5.241e-06
                       Rob.t.rat.(0)
asc_air                      1.35656
asc_bus                      1.30203
asc_rail                     1.19454
b_cost                     -10.51496
b_access_time               -1.60911
b_in_vehicle_time_air       -3.18763
b_in_vehicle_time_bus       -3.20651
b_in_vehicle_time_car       -2.20888
b_in_vehicle_time_rail      -2.55681
b_income_air                 1.66049
b_income_bus                -3.53201
b_income_rail               -0.01545</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="mode-choice-mnl-in-vehicle-answers.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-45_ac09e7594e8144df060f2cc9330b0e0a">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a><span class="co"># save results in current directory,</span></span>
<span id="cb47-2"><a href="#cb47-2"></a><span class="co"># using model name specified above</span></span>
<span id="cb47-3"><a href="#cb47-3"></a><span class="fu">apollo_saveOutput</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model output saved to /Users/mwbc/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/teaching/odum-discrete/Apollo_Mode_Choice_Flexible_output.txt 
Estimates saved to /Users/mwbc/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/teaching/odum-discrete/Apollo_Mode_Choice_Flexible_estimates.csv 
Model object saved to /Users/mwbc/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/teaching/odum-discrete/Apollo_Mode_Choice_Flexible.rds </code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="mode-choice-mnl-in-vehicle-answers.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-46_c0387171f32429ab1a53d60ef7dde668">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a><span class="fu">apollo_deltaMethod</span>(model, <span class="at">deltaMethod_settings=</span><span class="fu">list</span>(</span>
<span id="cb49-2"><a href="#cb49-2"></a>    <span class="at">expression=</span><span class="st">"b_in_vehicle_time_car * 60 / b_cost"</span></span>
<span id="cb49-3"><a href="#cb49-3"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running Delta method computation for user-defined function:

                          Expression  Value Robust s.e. Rob t-ratio (0)
 b_in_vehicle_time_car * 60 / b_cost 6.1495      2.7232            2.26</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="mode-choice-mnl-in-vehicle-answers.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-47_1b3eb675427afa86b4b0f296dab337c2">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a><span class="fu">apollo_deltaMethod</span>(model, <span class="at">deltaMethod_settings=</span><span class="fu">list</span>(</span>
<span id="cb51-2"><a href="#cb51-2"></a>    <span class="at">expression=</span><span class="st">"b_in_vehicle_time_air * 60 / b_cost"</span></span>
<span id="cb51-3"><a href="#cb51-3"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running Delta method computation for user-defined function:

                          Expression   Value Robust s.e. Rob t-ratio (0)
 b_in_vehicle_time_air * 60 / b_cost 36.7817     11.2664            3.26</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="mode-choice-mnl-in-vehicle-answers.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-48_3b49f6bb1b78146ca68b5c41001af876">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a><span class="fu">apollo_deltaMethod</span>(model, <span class="at">deltaMethod_settings=</span><span class="fu">list</span>(</span>
<span id="cb53-2"><a href="#cb53-2"></a>    <span class="at">expression=</span><span class="st">"b_in_vehicle_time_bus * 60 / b_cost"</span></span>
<span id="cb53-3"><a href="#cb53-3"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running Delta method computation for user-defined function:

                          Expression   Value Robust s.e. Rob t-ratio (0)
 b_in_vehicle_time_bus * 60 / b_cost 14.9048      4.6234            3.22</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="mode-choice-mnl-in-vehicle-answers.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-49_2860926437350c709dd50d5a6c1c1ec9">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a>dm <span class="ot">=</span> <span class="fu">apollo_deltaMethod</span>(model, <span class="at">deltaMethod_settings=</span><span class="fu">list</span>(</span>
<span id="cb55-2"><a href="#cb55-2"></a>    <span class="at">expression=</span><span class="st">"b_in_vehicle_time_rail * 60 / b_cost"</span></span>
<span id="cb55-3"><a href="#cb55-3"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running Delta method computation for user-defined function:

                           Expression   Value Robust s.e. Rob t-ratio (0)
 b_in_vehicle_time_rail * 60 / b_cost 20.2374      7.8836            2.57</code></pre>
</div>
</div>
</section>
<section id="interpretation" class="slide level2">
<h2>Interpretation</h2>

<img data-src="discrete-choice_files/figure-revealjs/unnamed-chunk-51-1.svg" alt="Bar plot of values of travel time for car, air, bus, and rail" width="1200" class="r-stretch quarto-figure-center"><ul>
<li>People really don’t like being on airplanes</li>
</ul>
</section>
<section id="correlation-does-not-imply-causation" class="slide level2">
<h2>Correlation does not imply causation</h2>

<img data-src="correlation_2x.png" class="r-stretch quarto-figure-center"><p class="caption">XKCD cartoon demonstrating that correlation does not imply causation</p></section>
<section id="correlation-does-not-imply-causation-1" class="slide level2">
<h2>Correlation does not imply causation</h2>
<ul>
<li>Of course we can’t interpret model coefficients as causal</li>
<li>Valuation estimates are derived from coefficients</li>
<li>Any bias in coefficients may affect valuation</li>
</ul>
</section>
<section id="correlation-does-not-imply-causation-2" class="slide level2">
<h2>Correlation does not imply causation</h2>
<ul>
<li>Often, prices will be correlated with unobserved positive aspects, biasing the value of time down
<ul>
<li>For example, legroom or class of service in the air travel case</li>
</ul></li>
<li>Other variable may be biased too
<ul>
<li>We don’t have number of connections in our model. How might this bias the value of time for air travel?</li>
</ul></li>
</ul>
</section>
<section id="questions-2" class="slide level2">
<h2>Questions?</h2>
</section></section>
<section>
<section id="predictions-and-market-shares" class="title-slide slide level1 center">
<h1>Predictions and market shares</h1>
<ul>
<li>Often, you will want to use your model to make some prediction</li>
<li>For example, maybe we want to reduce use of air travel for climate reasons, so we decide to add a £25 tax</li>
<li>Mathematically, we can use the formulas above to calculate probabilities for any</li>
<li>We can use the <code>apollo_prediction</code> function to do predictions within Apollo</li>
</ul>
</section>
<section id="predictions-and-market-shares-in-r" class="slide level2">
<h2>Predictions and market shares in R</h2>
<div class="cell" data-filename="prediction.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-53_b896f74d5c03c3e01e30dd6e10846eb2">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a><span class="co"># Make predictions for the existing dataset</span></span>
<span id="cb57-2"><a href="#cb57-2"></a>predictions <span class="ot">=</span></span>
<span id="cb57-3"><a href="#cb57-3"></a>    <span class="fu">apollo_prediction</span>(model, apollo_probabilities, apollo_inputs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running predictions from model using parameter estimates...
Prediction at model estimates
             car    air   rail    bus
Aggregate 332.00 215.00 327.00 126.00
Average     0.33   0.21   0.33   0.13

The output from apollo_prediction is a matrix containing the
  predictions at the estimated values.</code></pre>
</div>
</div>
</section>
<section id="predictions-and-market-shares-in-r-1" class="slide level2">
<h2>Predictions and market shares in R</h2>
<ul>
<li><code>predictions</code> is now a matrix with one row per observation and one column per outcome</li>
<li>These contain the predicted probabilities for each observation, based on the estimation dataset</li>
</ul>
</section>
<section id="predictions-and-market-shares-in-r-2" class="slide level2">
<h2>Predictions and market shares in R</h2>
<ul>
<li>Most often, you will want to make a prediction for a <em>counterfactual</em> scenario, i.e.&nbsp;a change to the data</li>
<li>This is kind of clunky in Apollo; you modify the database directly, and then re-run <code>apollo_validateInputs</code> and <code>apollo_prediction</code></li>
</ul>
</section>
<section id="predictions-and-market-shares-in-r-3" class="slide level2">
<h2>Predictions and market shares in R</h2>
<p><code>predictions.R</code></p>
<div class="cell" data-filename="prediction.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-54_abfd4c0dc4022adc1b193e275a118de4">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1"></a><span class="co"># Now, make predictions in a counterfactual scenario</span></span>
<span id="cb59-2"><a href="#cb59-2"></a><span class="co"># First, we will give the original database a new name</span></span>
<span id="cb59-3"><a href="#cb59-3"></a>original_database <span class="ot">=</span> database</span>
<span id="cb59-4"><a href="#cb59-4"></a></span>
<span id="cb59-5"><a href="#cb59-5"></a><span class="co"># then, we will adjust the cost_air column to add a 25 pound tax</span></span>
<span id="cb59-6"><a href="#cb59-6"></a><span class="co"># any time air is available</span></span>
<span id="cb59-7"><a href="#cb59-7"></a>database <span class="ot">=</span> <span class="fu">mutate</span>(</span>
<span id="cb59-8"><a href="#cb59-8"></a>    original_database,</span>
<span id="cb59-9"><a href="#cb59-9"></a>    <span class="at">cost_air=</span><span class="fu">ifelse</span>(av_air, cost_air <span class="sc">+</span> <span class="dv">25</span>, cost_air)</span>
<span id="cb59-10"><a href="#cb59-10"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="prediction.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-55_f58e5851ece16881e7c37749ff841b8d">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a><span class="co"># now that we have a new variable called "database," we run</span></span>
<span id="cb60-2"><a href="#cb60-2"></a><span class="co"># apollo_validateInputs again, and then apollo_probabilities</span></span>
<span id="cb60-3"><a href="#cb60-3"></a><span class="co"># apollo_validateInputs will always use the variable called</span></span>
<span id="cb60-4"><a href="#cb60-4"></a><span class="co"># "database"</span></span>
<span id="cb60-5"><a href="#cb60-5"></a>apollo_inputs <span class="ot">=</span> <span class="fu">apollo_validateInputs</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Several observations per individual detected based on the value of ID.
  Setting panelData in apollo_control set to TRUE.
All checks on apollo_control completed.
All checks on database completed.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1"></a>tax_predictions <span class="ot">=</span></span>
<span id="cb62-2"><a href="#cb62-2"></a>    <span class="fu">apollo_prediction</span>(model, apollo_probabilities, apollo_inputs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running predictions from model using parameter estimates...
Prediction at model estimates
             car    air   rail    bus
Aggregate 367.46 121.08 366.61 144.85
Average     0.37   0.12   0.37   0.14

The output from apollo_prediction is a matrix containing the
  predictions at the estimated values.</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="prediction.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-56_c0d0cf198af832fb8dafe67b69503b1f">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1"></a><span class="co"># now, we can use the two predictions to compute changes in market shares</span></span>
<span id="cb64-2"><a href="#cb64-2"></a><span class="co"># first, original market shares</span></span>
<span id="cb64-3"><a href="#cb64-3"></a>orig_mktshares <span class="ot">=</span> <span class="fu">apply</span>(</span>
<span id="cb64-4"><a href="#cb64-4"></a>    predictions[,<span class="fu">c</span>(<span class="st">"car"</span>, <span class="st">"rail"</span>, <span class="st">"air"</span>, <span class="st">"bus"</span>)],</span>
<span id="cb64-5"><a href="#cb64-5"></a>    <span class="dv">2</span>,</span>
<span id="cb64-6"><a href="#cb64-6"></a>    mean</span>
<span id="cb64-7"><a href="#cb64-7"></a>)</span>
<span id="cb64-8"><a href="#cb64-8"></a>orig_mktshares</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      car      rail       air       bus 
0.3319992 0.3269988 0.2149990 0.1260030 </code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="prediction.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-57_cff3db594de3a421de4e5cf71d450b8e">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1"></a><span class="co"># next, taxed market shares</span></span>
<span id="cb66-2"><a href="#cb66-2"></a>tax_mktshares <span class="ot">=</span> <span class="fu">apply</span>(</span>
<span id="cb66-3"><a href="#cb66-3"></a>    tax_predictions[,<span class="fu">c</span>(<span class="st">"car"</span>, <span class="st">"rail"</span>, <span class="st">"air"</span>, <span class="st">"bus"</span>)],</span>
<span id="cb66-4"><a href="#cb66-4"></a>    <span class="dv">2</span>,</span>
<span id="cb66-5"><a href="#cb66-5"></a>    mean</span>
<span id="cb66-6"><a href="#cb66-6"></a>)</span>
<span id="cb66-7"><a href="#cb66-7"></a>tax_mktshares</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      car      rail       air       bus 
0.3674632 0.3666085 0.1210767 0.1448517 </code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="prediction.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-58_8ba3715bf38646a7ebbb20a46f1184b3">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1"></a><span class="co"># and finally, their difference. Is this the change we</span></span>
<span id="cb68-2"><a href="#cb68-2"></a><span class="co"># expect to see?</span></span>
<span id="cb68-3"><a href="#cb68-3"></a>tax_mktshares <span class="sc">-</span> orig_mktshares</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        car        rail         air         bus 
 0.03546394  0.03960968 -0.09392234  0.01884872 </code></pre>
</div>
</div>
</section>
<section id="exercise-1" class="slide level2">
<h2>Exercise</h2>
<ul>
<li>How would new rail infrastructure that reduces journey times 25% affect market shares?
<ul>
<li>Remember to restore original database, and run <code>apollo_validateInputs</code> every time you change the database!</li>
</ul></li>
<li>My solution in <code>prediction-answers.R</code></li>
</ul>
</section>
<section id="answers" class="slide level2">
<h2>Answers</h2>
<div class="cell" data-filename="prediction-answers.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-59_78f9fdf1e172f46bb2ce7abf6ef26b91">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1"></a><span class="co"># adjust travel times</span></span>
<span id="cb70-2"><a href="#cb70-2"></a>database <span class="ot">=</span> <span class="fu">mutate</span>(</span>
<span id="cb70-3"><a href="#cb70-3"></a>    original_database,</span>
<span id="cb70-4"><a href="#cb70-4"></a>    <span class="at">time_rail=</span>time_rail<span class="sc">*</span><span class="fl">0.75</span></span>
<span id="cb70-5"><a href="#cb70-5"></a>    )</span>
<span id="cb70-6"><a href="#cb70-6"></a></span>
<span id="cb70-7"><a href="#cb70-7"></a><span class="co"># re-load inputs</span></span>
<span id="cb70-8"><a href="#cb70-8"></a>apollo_inputs <span class="ot">=</span> <span class="fu">apollo_validateInputs</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Several observations per individual detected based on the value of ID.
  Setting panelData in apollo_control set to TRUE.
All checks on apollo_control completed.
All checks on database completed.</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="prediction-answers.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-60_dae7e82ce6e717bdfc4d4ecfd2ad7a5b">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1"></a><span class="co"># Make predictions</span></span>
<span id="cb72-2"><a href="#cb72-2"></a>fast_rail_predictions <span class="ot">=</span></span>
<span id="cb72-3"><a href="#cb72-3"></a>    <span class="fu">apollo_prediction</span>(model, apollo_probabilities, apollo_inputs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running predictions from model using parameter estimates...
Prediction at model estimates
             car    air   rail    bus
Aggregate 294.12 191.33 404.31 110.24
Average     0.29   0.19   0.40   0.11

The output from apollo_prediction is a matrix containing the
  predictions at the estimated values.</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="prediction-answers.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-61_e8e0a46e6df02699323b8aa2433c8c2d">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a><span class="co"># compute market shares</span></span>
<span id="cb74-2"><a href="#cb74-2"></a>fast_rail_mktshares <span class="ot">=</span> <span class="fu">apply</span>(</span>
<span id="cb74-3"><a href="#cb74-3"></a>    fast_rail_predictions[,<span class="fu">c</span>(<span class="st">"car"</span>, <span class="st">"rail"</span>, <span class="st">"air"</span>, <span class="st">"bus"</span>)],</span>
<span id="cb74-4"><a href="#cb74-4"></a>    <span class="dv">2</span>,</span>
<span id="cb74-5"><a href="#cb74-5"></a>    mean</span>
<span id="cb74-6"><a href="#cb74-6"></a>)</span>
<span id="cb74-7"><a href="#cb74-7"></a>fast_rail_mktshares</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      car      rail       air       bus 
0.2941170 0.4043091 0.1913297 0.1102442 </code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="prediction-answers.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-62_412712daeae29362ee19f360840f94ed">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1"></a><span class="co"># compute differences</span></span>
<span id="cb76-2"><a href="#cb76-2"></a><span class="co"># if you need to recalculate orig_mktshares, make sure</span></span>
<span id="cb76-3"><a href="#cb76-3"></a><span class="co"># you re-run apollo_validateInputs before calculating</span></span>
<span id="cb76-4"><a href="#cb76-4"></a>fast_rail_mktshares <span class="sc">-</span> orig_mktshares</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        car        rail         air         bus 
-0.03788217  0.07731030 -0.02366936 -0.01575876 </code></pre>
</div>
</div>
</section></section>
<section id="logit-model-estimation-maximum-likelihood" class="title-slide slide level1 center">
<h1>Logit model estimation: maximum likelihood</h1>
<ul>
<li>Unlike linear regression, there is no closed-form solution
<ul>
<li>i.e.&nbsp;one you can just calculate</li>
</ul></li>
<li>Instead, we use <em>maximum likelihood</em></li>
<li>We define a <em>likelihood function</em> which tells us how likely we are to observe the data we have, given a set of coefficients</li>
</ul>
</section>

<section>
<section id="logit-model-estimation-maximum-likelihood-1" class="title-slide slide level1 center">
<h1>Logit model estimation: maximum likelihood</h1>
<ul>
<li>We then choose a set of coefficients, the <em>starting values</em>, and adjust them until we find the best fit—the maximum of the likelihood function</li>
</ul>
</section>
<section id="likelihood-function-for-a-discrete-choice-model" class="slide level2">
<h2>Likelihood function for a discrete choice model</h2>
<ul>
<li>The likelihood function for a discrete choice model is the joint probability of all the chosen values</li>
<li>If you had three people, who chose car, car, and bus to get to work, likelihood is the probability that the first person chose car multiplied by the probability the second person chose car multiplied by the probability the third person chose bus</li>
</ul>
</section>
<section id="likelihood-function-for-a-discrete-choice-model-the-math" class="slide level2">
<h2>Likelihood function for a discrete choice model: the math</h2>
<ul>
<li>In math:</li>
</ul>
<p><span class="math display">\[
\prod_n P(y_n | x_n)\\
= \prod_n \frac{e^{U_{y_n}}}{\sum_j e^{U_{j_n}}}
\]</span></p>
</section>
<section id="likelihood-function-for-a-discrete-choice-model-the-math-1" class="slide level2">
<h2>Likelihood function for a discrete choice model: the math</h2>
<ul>
<li>This is a vanishingly small number
<ul>
<li>In our mode choice example, something like <span class="math inline">\(10^{-440}\)</span></li>
</ul></li>
<li>Generally too small to be represented in a computer</li>
</ul>
<div class="cell" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-63_5d15afa4862507697af6c2c95b0cc0dd">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1"></a><span class="dv">10</span><span class="sc">^-</span><span class="dv">440</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
</section>
<section id="likelihood-function-for-a-discrete-choice-model-the-math-2" class="slide level2">
<h2>Likelihood function for a discrete choice model: the math</h2>
<ul>
<li>Instead, computers use the logarithm of likelihood (log-likelihood)</li>
</ul>
<p><span class="math display">\[
\mathrm{ln} \prod_n P(y_n | x_n)\\
= \sum_n \mathrm{ln} \frac{e^{U_{y_n}}}{\sum_j e^{U_{j_n}}}
\]</span></p>
<ul>
<li>In our example above, this is -1014</li>
</ul>
</section>
<section id="comparing-logistic-models-to-each-other" class="slide level2">
<h2>Comparing logistic models to each other</h2>
<ul>
<li>We can use the log-likelihood to compare two models using a likelihood-ratio test</li>
<li>This only works if the two models are <em>nested</em>
<ul>
<li>That is, one is a subset of the other, or you can make one into the other by constraining parameters</li>
<li>Not to be confused with <em>nested logit models</em> which use a different error structure</li>
</ul></li>
</ul>
</section>
<section id="comparing-logistic-models-to-each-other-1" class="slide level2">
<h2>Comparing logistic models to each other</h2>
<ul>
<li>Likelihood ratio test statistic is</li>
</ul>
<p><span class="math display">\[
-2(\ell_1 - \ell_2)
\]</span></p>
<p>where <span class="math inline">\(\ell_1\)</span> is the likelihood of the less flexible model and <span class="math inline">\(\ell_2\)</span> the more flexible model</p>
</section>
<section id="comparing-logistic-models-to-each-other-2" class="slide level2">
<h2>Comparing logistic models to each other</h2>
<ul>
<li>This is <span class="math inline">\(\chi^2\)</span>-distributed with degrees of freedom equal to the number of additional parameters in the more flexible model</li>
<li>Don’t need to remember order, just put them in the order that makes test statistic positive</li>
</ul>
</section>
<section id="comparing-logistic-models-to-each-other-3" class="slide level2">
<h2>Comparing logistic models to each other</h2>
<table>
<thead>
<tr class="header">
<th>Model</th>
<th>Log-likelihood</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Same in-vehicle time coefficient</td>
<td>-1020</td>
</tr>
<tr class="even">
<td>Different in-vehicle time coefficients</td>
<td>-1014.74</td>
</tr>
<tr class="odd">
<td>Test statistic</td>
<td>10.52</td>
</tr>
<tr class="even">
<td>Degrees of freedom</td>
<td>3</td>
</tr>
</tbody>
</table>
</section>
<section id="comparing-logistic-regression-models-to-each-other" class="slide level2">
<h2>Comparing logistic regression models to each other</h2>
<div class="cell" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-64_4254bc81f23bdbf25f632c6d22659e29">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1"></a><span class="dv">1</span> <span class="sc">-</span> <span class="fu">pchisq</span>(<span class="fl">10.52</span>, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01462584</code></pre>
</div>
</div>
</section>
<section id="comparing-logistic-regreession-models-to-each-other-with-apollo" class="slide level2">
<h2>Comparing logistic regreession models to each other with Apollo</h2>
<ul>
<li>If we have given our models unique names and run <code>apollo_saveOutput</code>, Apollo can do the test for us</li>
</ul>
<div class="cell" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-65_6ba5163fe15eb412e9bc62e276acf4e8">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1"></a><span class="fu">apollo_lrTest</span>(<span class="st">"Apollo_Mode_Choice"</span>, <span class="st">"Apollo_Mode_Choice_Flexible"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                  LL par
Apollo_Mode_Choice          -1020.00   9
Apollo_Mode_Choice_Flexible -1014.74  12
Difference                      5.26   3

Likelihood ratio test-value:    10.52 
Degrees of freedom:             3 
Likelihood ratio test p-value:  0.01463 </code></pre>
</div>
</div>
</section>
<section id="goodness-of-fit-metrics-for-logistic-regression-models" class="slide level2">
<h2>Goodness of fit metrics for logistic regression models</h2>
<ul>
<li>Unlike linear regression, there is no <span class="math inline">\(R^2\)</span> for a logistic regression</li>
<li>We can compare multiple models using a likelihood-ratio test</li>
<li>But what if we don’t have multiple models?</li>
</ul>
</section>
<section id="goodness-of-fit-metrics-for-logistic-regression-models-1" class="slide level2">
<h2>Goodness of fit metrics for logistic regression models</h2>
<ul>
<li>We do have the log-likelihood with all coefficients at 0 [LL(0)], and with only ASCs [LL(C)]</li>
</ul>
<pre><code>LL(0)                            : -1170.86
LL(C)                            : -1085.14
LL(final)                        : -1020</code></pre>
</section>
<section id="goodness-of-fit-metrics-for-logistic-regression-models-2" class="slide level2">
<h2>Goodness of fit metrics for logistic regression models</h2>
<ul>
<li>Many authors have created pseudo-<span class="math inline">\(R^2\)</span> metrics based on how much the model improves loglikelihood relative to these “base” log-likelihoods</li>
<li>Most common is probably McFadden’s, <span class="math inline">\(1 - \frac{\ell}{\ell_C}\)</span></li>
<li>Or McFadden’s adjusted, <span class="math inline">\(1 - \frac{\ell - K}{\ell_C}\)</span> where <span class="math inline">\(K\)</span> is number of estimated coefficients, which attempts to correct for overfitting</li>
</ul>
</section>
<section id="goodness-of-fit-metrics-for-logistic-regression-models-3" class="slide level2">
<h2>Goodness of fit metrics for logistic regression models</h2>
<ul>
<li>These range from 0 to 1, like an <span class="math inline">\(R^2\)</span>, with higher values being better fit</li>
<li>They can be relative to log-likelihood at constants or log-likelihood at zero
<ul>
<li>Former is more like the <span class="math inline">\(R^2\)</span> you’ve seen in linear models, which is usually relative to the mean of <span class="math inline">\(y\)</span></li>
</ul></li>
<li>Anecdotally, pseudo-<span class="math inline">\(R^2\)</span> statistics tend to be fairly low</li>
</ul>
</section>
<section id="comparing-coefficients-of-logistic-regression-models" class="slide level2">
<h2>Comparing coefficients of logistic regression models</h2>
<ul>
<li>In general, you <em>can’t directly compare coefficients from different logistic regressions</em></li>
<li>They may be scaled differently</li>
<li>In a linear regression, the coefficients have the same scale as the dependent variable</li>
<li>But in logistic regression, utility is scaleless</li>
</ul>
</section>
<section id="how-is-the-scale-set-in-logistic-regression" class="slide level2">
<h2>How is the scale set in logistic regression?</h2>
<ul>
<li>The scale of coefficients is arbitrary, but the larger the coefficients are the larger the variance of the error term must be to produce the same predictions</li>
<li>Multinomial logistic regression has a “scale parameter” which controls the scale of the error and thus the scale of the coefficients, usually assumed to equal 1</li>
<li>But if you add predictors to a model so that there is less unexplained variation, the scale of the error term is fixed, so scale of other coefficients will change</li>
</ul>
</section>
<section id="marginal-effects" class="slide level2">
<h2>Marginal effects</h2>
<ul>
<li>One solution to this problem is to use <em>marginal effects</em>—the average change in probability for a unit change in an independent variable</li>
<li>This has a scale - the probability scale</li>
<li>The marginal effect of a variable depends on the value of that and all other variables due to nonlinearities</li>
<li>Hence, the <em>average marginal effect</em>
<ul>
<li>Usually, the marginal effect averaged over the entire sample</li>
<li>Sometimes, the marginal effect at mean values for all covariates</li>
</ul></li>
</ul>
</section>
<section id="marginal-effects-in-apollo" class="slide level2">
<h2>Marginal effects in Apollo</h2>
<ul>
<li>Apollo doesn’t have a function to directly calculate marginal effects</li>
<li>But, we can use prediction function to calculate on our own</li>
<li>Let’s calculate the marginal effect of in-vehicle travel time by car on all modes</li>
</ul>
</section>
<section id="marginal-effects-in-apollo-1" class="slide level2">
<h2>Marginal effects in Apollo</h2>
<ul>
<li>We’ll add a small amount to <code>time_car</code> and recalculate probabilities</li>
<li>We’ll then divide the change by that small amount to estimate the marginal effect</li>
<li>This is a basic finite-differences approximation of the marginal effect</li>
</ul>
</section>
<section class="slide level2">

<p><code>margins.R</code></p>
<div class="cell" data-filename="margins.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-66_382ac303610582cd9ea00c7606062c7a">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1"></a><span class="co"># Run this after running mode-choice-mnl-in-vehicle-answers.R and predictions.R</span></span>
<span id="cb85-2"><a href="#cb85-2"></a></span>
<span id="cb85-3"><a href="#cb85-3"></a><span class="co"># First, we will add 0.01 to the in-vehicle travel time by car</span></span>
<span id="cb85-4"><a href="#cb85-4"></a>database <span class="ot">=</span></span>
<span id="cb85-5"><a href="#cb85-5"></a>    <span class="fu">mutate</span>(original_database, <span class="at">time_car=</span><span class="fu">ifelse</span>(av_car, time_car <span class="sc">+</span> <span class="fl">0.01</span>, time_car))</span>
<span id="cb85-6"><a href="#cb85-6"></a></span>
<span id="cb85-7"><a href="#cb85-7"></a><span class="co"># re-read inputs</span></span>
<span id="cb85-8"><a href="#cb85-8"></a>apollo_inputs <span class="ot">=</span> <span class="fu">apollo_validateInputs</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Several observations per individual detected based on the value of ID.
  Setting panelData in apollo_control set to TRUE.
All checks on apollo_control completed.
All checks on database completed.</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="margins.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-67_42bdf443069657c7c610a02efb13bdcc">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1"></a>meff_predictions <span class="ot">=</span></span>
<span id="cb87-2"><a href="#cb87-2"></a>    <span class="fu">apollo_prediction</span>(model, apollo_probabilities, apollo_inputs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running predictions from model using parameter estimates...
Prediction at model estimates
             car    air   rail    bus
Aggregate 331.99 215.00 327.00 126.00
Average     0.33   0.22   0.33   0.13

The output from apollo_prediction is a matrix containing the
  predictions at the estimated values.</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="margins.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-68_60a614d5c3bab788a3b8d2284f40f077">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1"></a><span class="co"># now, we can compute the per-observation marginal effect</span></span>
<span id="cb89-2"><a href="#cb89-2"></a><span class="co"># We divide by 0.01 to scale the marginal effects to a unit</span></span>
<span id="cb89-3"><a href="#cb89-3"></a><span class="co"># change in the independent variable, because this is the</span></span>
<span id="cb89-4"><a href="#cb89-4"></a><span class="co"># amount we added above</span></span>
<span id="cb89-5"><a href="#cb89-5"></a>obs_meff <span class="ot">=</span> (meff_predictions <span class="sc">-</span> predictions) <span class="sc">/</span> <span class="fl">0.01</span></span>
<span id="cb89-6"><a href="#cb89-6"></a></span>
<span id="cb89-7"><a href="#cb89-7"></a><span class="co"># now, we average to get the average marginal effect</span></span>
<span id="cb89-8"><a href="#cb89-8"></a><span class="fu">apply</span>(obs_meff[,<span class="fu">c</span>(<span class="st">"car"</span>, <span class="st">"bus"</span>, <span class="st">"rail"</span>, <span class="st">"air"</span>)], <span class="dv">2</span>, mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          car           bus          rail           air 
-0.0006134619  0.0001276546  0.0003080833  0.0001777240 </code></pre>
</div>
</div>
</section>
<section id="interpreting-marginal-effects" class="slide level2">
<h2>Interpreting marginal effects</h2>
<ul>
<li>Increasing travel time by car has a large negative effect on probability of choosing car</li>
<li>Users are diverted primarily to rail, to air and bus to a lesser extent</li>
<li>These are in probability units, so we can compare between models</li>
<li>They are small, but they are per additional minute of travel time</li>
<li>These marginal effects are dependent on the distribution of covariates in our sample</li>
</ul>
</section>
<section id="considerations-when-using-marginal-effects" class="slide level2">
<h2>Considerations when using marginal effects</h2>
<ul>
<li>Dummy variables - may want to perform prediction with all dummies set to zero and one, rather than adding 0.01 to a dummy variable</li>
<li>May want to use weights if your data have them, even if model is unweighted</li>
<li>Elasticities are also a possibility, computing relative change in probability for a relative change in variables</li>
</ul>
</section>
<section id="exercise-2" class="slide level2">
<h2>Exercise</h2>
<ul>
<li>Compute and interpret marginal effects for income
<ul>
<li>My solution: <code>margins-answers.R</code></li>
</ul></li>
</ul>
</section>
<section id="answers-1" class="slide level2">
<h2>Answers</h2>
<div class="cell" data-filename="margins-answers.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-69_d7f0eb33d724f9d9592ce38b2d166fb5">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1"></a><span class="co"># Run this after running mode-choice-mnl-in-vehicle-answers.R and predictions.R</span></span>
<span id="cb91-2"><a href="#cb91-2"></a></span>
<span id="cb91-3"><a href="#cb91-3"></a><span class="co"># First, we will add 0.01 to the income</span></span>
<span id="cb91-4"><a href="#cb91-4"></a>database <span class="ot">=</span></span>
<span id="cb91-5"><a href="#cb91-5"></a>    <span class="fu">mutate</span>(original_database, <span class="at">income=</span><span class="fu">ifelse</span>(av_car, income <span class="sc">+</span> <span class="fl">0.01</span>, income))</span>
<span id="cb91-6"><a href="#cb91-6"></a></span>
<span id="cb91-7"><a href="#cb91-7"></a><span class="co"># re-read inputs</span></span>
<span id="cb91-8"><a href="#cb91-8"></a>apollo_inputs <span class="ot">=</span> <span class="fu">apollo_validateInputs</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Several observations per individual detected based on the value of ID.
  Setting panelData in apollo_control set to TRUE.
All checks on apollo_control completed.
All checks on database completed.</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="margins-answers.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-70_44dda125cc7aa122e2bc0460aa911193">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1"></a><span class="co"># now, do the predictions</span></span>
<span id="cb93-2"><a href="#cb93-2"></a>meff_predictions <span class="ot">=</span></span>
<span id="cb93-3"><a href="#cb93-3"></a>    <span class="fu">apollo_prediction</span>(model, apollo_probabilities, apollo_inputs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running predictions from model using parameter estimates...
Prediction at model estimates
             car    air   rail    bus
Aggregate 332.00 215.00 327.00 126.00
Average     0.33   0.21   0.33   0.13

The output from apollo_prediction is a matrix containing the
  predictions at the estimated values.</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="margins-answers.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-71_8a7c110378dfa04237c20ff66f4d0df0">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1"></a><span class="co"># now, we can compute the per-observation marginal effect</span></span>
<span id="cb95-2"><a href="#cb95-2"></a><span class="co"># We divide by 0.01 to scale the marginal effects to a unit</span></span>
<span id="cb95-3"><a href="#cb95-3"></a><span class="co"># change in the independent variable, because this is the</span></span>
<span id="cb95-4"><a href="#cb95-4"></a><span class="co"># amount we added above</span></span>
<span id="cb95-5"><a href="#cb95-5"></a>obs_meff <span class="ot">=</span> (meff_predictions <span class="sc">-</span> predictions) <span class="sc">/</span> <span class="fl">0.01</span></span>
<span id="cb95-6"><a href="#cb95-6"></a></span>
<span id="cb95-7"><a href="#cb95-7"></a><span class="co"># now, we average to get the average marginal effect</span></span>
<span id="cb95-8"><a href="#cb95-8"></a><span class="fu">apply</span>(obs_meff[,<span class="fu">c</span>(<span class="st">"car"</span>, <span class="st">"bus"</span>, <span class="st">"rail"</span>, <span class="st">"air"</span>)], <span class="dv">2</span>, mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          car           bus          rail           air 
 3.513233e-07 -1.727214e-06  1.655256e-07  1.210365e-06 </code></pre>
</div>
</div>
</section></section>
<section>
<section id="practical-application-of-choice-models" class="title-slide slide level1 center">
<h1>Practical application of choice models</h1>

</section>
<section id="data-acquisition" class="slide level2">
<h2>Data acquisition</h2>
<ul>
<li>Data acquisition is very difficult if you want to include attributes of the alternatives
<ul>
<li>You don’t <em>have</em> to include attributes of alternatives, depends on your research question</li>
</ul></li>
<li>You need information not only on people did do, but what they could have done but chose not to</li>
</ul>
</section>
<section id="data-acquisition-1" class="slide level2">
<h2>Data acquisition</h2>
<ul>
<li>One option is to do stated-preference surveys</li>
<li>You can include <em>choice experiments</em> where you present aspects of alternatives and ask respondents to choose</li>
<li>Then you have all the alternative attributes</li>
<li>But you still need to make sure they’re reasonable, and standard stated-preference caveats apply (e.g.&nbsp;social desirability bias)</li>
</ul>
</section>
<section id="data-acquisition-2" class="slide level2">
<h2>Data acquisition</h2>
<ul>
<li>For revealed preference, you need to come up with alternative attributes yourself</li>
<li>In transport, we often use trip planning software to do this (e.g.&nbsp;Google Maps, OSRM, r5r)</li>
</ul>
</section>
<section id="pitfalls-of-apollo" class="slide level2">
<h2>Pitfalls of <em>Apollo</em></h2>
<ul>
<li>Apollo works with global variables in R and expects some variables to have specific names
<ul>
<li>e.g.&nbsp;<code>database</code></li>
</ul></li>
<li>This means that settings and data may “leak” between models if you don’t clear your environment between estimations</li>
</ul>
</section></section>
<section>
<section id="independence-of-irrelevant-alternatives" class="title-slide slide level1 center">
<h1>Independence of irrelevant alternatives</h1>
<ul>
<li>When the utility of one alternative is increased, the probabilities of the other alternatives decrease in proportion to their probabilities
<ul>
<li>And vice-versa</li>
<li>Similarly when an alternative is added or removed</li>
</ul></li>
</ul>
</section>
<section id="the-red-busblue-bus-problem" class="slide level2">
<h2>The red bus/blue bus problem</h2>
<ul>
<li>Suppose you have a model of mode choice, with two alternatives: driving and a red bus</li>
<li>One individual has a 50% probability of choosing each alternative</li>
<li>Suppose you paint half the buses red but don’t change anything about the service</li>
</ul>
</section>
<section id="the-red-busblue-bus-problem-1" class="slide level2">
<h2>The red bus/blue bus problem</h2>
<ul>
<li>You’d expect this individual to now have probabilities 25% red bus, 25% blue bus, and 50% drive</li>
<li>But, half of the probability has to come from each other alternative</li>
<li>So, if blue bus has 25% probability, existing choices must all reduce by the same factor</li>
<li>Red bus: 50% * .75 = 37.5%</li>
<li>Same for car</li>
</ul>
</section>
<section id="independence-of-irrelevant-alternatives-the-red-busblue-bus-problem" class="slide level2">
<h2>Independence of irrelevant alternatives: the red bus/blue bus problem</h2>
<ul>
<li>This is true at the individual level, not the level of market shares <span class="citation" data-cites="ben-akiva_discrete_1985">(<a href="#/ref-ben-akiva_discrete_1985" role="doc-biblioref" onclick="return false;">Ben-Akiva and Lerman 1985, 109–11</a>)</span></li>
</ul>
</section>
<section id="independence-of-irrelevant-alternatives-the-math" class="slide level2">
<h2>Independence of irrelevant alternatives: the math</h2>
<p><span class="math display">\[ \frac{\delta p(b)}{\delta U_r}\]</span></p>
<p><span class="math display">\[
= \frac{
    e^{U_b}}{
        e^{U_r} + e^{U_b} + e^{U_c}}
    \frac{\delta}{\delta U_r}
\]</span></p>
<p><span class="math display">\[
    = e^{U_b} \big[ ( e^{U_r} + e^{U_b} + e^{U_c} \big)^{-1} \frac{\delta}{\delta U_r} \big]
\]</span></p>
</section>
<section id="questions-3" class="slide level2">
<h2>Questions?</h2>
</section></section>
<section>
<section id="nested-logit-model" class="title-slide slide level1 center">
<h1>Nested logit model</h1>

</section>
<section id="motivation" class="slide level2">
<h2>Motivation</h2>
<ul>
<li>The independence of irrelevant alternatives property of MNL derives from the assumed error distribution
<ul>
<li>Which is also how the probability function is derived</li>
</ul></li>
<li>Nested logit allows correlation within “nests” of alternatives</li>
<li>Often used in mode choice or joint choice</li>
</ul>
</section>
<section id="model-form" class="slide level2">
<h2>Model form</h2>
<div class="cell" data-reveal="true">
<div class="cell-output-display">
<div>
<p>
</p><pre class="mermaid" data-tooltip-selector="#mermaid-tooltip-1">flowchart LR
    mc[Mode choice]
    car[Car]
    air[Air]
    bus[Bus]
    train[Train]

    mc --&gt; car
    mc --&gt; air
    mc --&gt; bus
    mc --&gt; train

</pre>
<div id="mermaid-tooltip-1" class="mermaidTooltip">

</div>
<p></p>
</div>
</div>
</div>
</section>
<section id="model-form-1" class="slide level2">
<h2>Model form</h2>
<div class="cell" data-reveal="true">
<div class="cell-output-display">
<div>
<p>
</p><pre class="mermaid" data-tooltip-selector="#mermaid-tooltip-2">flowchart LR
    mc[Mode choice]
    car[Car]
    air[Air]
    transit[Transit]
    bus[Bus]
    train[Train]

    mc --&gt; car
    mc --&gt; air
    mc --&gt; transit
    transit --&gt; bus
    transit --&gt; train
</pre>
<div id="mermaid-tooltip-2" class="mermaidTooltip">

</div>
<p></p>
</div>
</div>
</div>
</section>
<section id="model-form-2" class="slide level2">
<h2>Model form</h2>
<ul>
<li>Often used to represent hierarchical or joint choice</li>
<li>Used when there are <em>shared unobserved attributes</em> between alternatives
<ul>
<li>In the red bus/blue bus problem, attributes of the bus</li>
</ul></li>
<li>Does not have to, just represents correlation in error term between alternatives</li>
</ul>
</section>
<section id="nested-logit-the-math" class="slide level2">
<h2>Nested logit: the math</h2>
<p><span class="math display">\[
U_i = \alpha_i + \beta_{ix} x_i + \cdots + \epsilon_{nest} + \epsilon_{i}
\]</span></p>
<ul>
<li><span class="math inline">\(\epsilon_{nest}\)</span> allows correlation of error terms at the nest level</li>
</ul>
</section>
<section id="why-do-correlated-error-terms-solve-the-red-busblue-bus-problem" class="slide level2">
<h2>Why do correlated error terms solve the red bus/blue bus problem?</h2>
<ul>
<li>Easier to reason through than to do the math</li>
<li>Definition of a random-utility model is that whatever alternative has the highest utility is chosen</li>
<li>Utility has a random component <span class="math inline">\(\epsilon\)</span>, so whether an alternative has highest utility is probabilistic</li>
</ul>
</section>
<section id="why-do-correlated-error-terms-solve-the-red-busblue-bus-problem-1" class="slide level2">
<h2>Why do correlated error terms solve the red bus/blue bus problem?</h2>
<ul>
<li>Suppose we are modeling the probability of auto vs.&nbsp;red bus vs.&nbsp;blue bus, and the systematic utilities are all 0</li>
<li>So whichever alternative has the highest random error will be chosen</li>
<li>Suppose we draw the error terms at random from a hat containing numbers 1–10</li>
<li>The probability that any one error term is the largest is 1/3</li>
</ul>
</section>
<section id="why-do-correlated-error-terms-solve-the-red-busblue-bus-problem-2" class="slide level2">
<h2>Why do correlated error terms solve the red bus/blue bus problem?</h2>
<ul>
<li>But suppose we think that the unobserved attributes of the red bus and blue bus are the same</li>
<li>Then we will draw one number for cars, and the <em>same number twice</em> for the red and blue buses</li>
<li>Since the error terms for the buses are the same, there is now a 50% chance that car will have highest utility, and 50% that the buses will</li>
</ul>
</section>
<section id="nested-logit-additional-parameters" class="slide level2">
<h2>Nested logit: additional parameters</h2>
<ul>
<li>The nested logit adds one additional parameter per nest, the <em>inclusive value</em> parameter</li>
<li>Also called <span class="math inline">\(\theta\)</span>, <span class="math inline">\(\lambda\)</span>, <span class="math inline">\(\frac{\mu_m}{\mu_d}\)</span>, <span class="math inline">\(\frac{1}{\mu_d}\)</span>, logsum parameter</li>
<li>Inclusive value parameters define how much correlation there is in the alternatives within a nest</li>
</ul>
</section>
<section id="nested-logit-interpreting-the-inclusive-value-parameter" class="slide level2">
<h2>Nested logit: interpreting the inclusive value parameter</h2>
<ul>
<li>Inclusive value parameters <em>should</em> be between 0 and 1 to align with utility theory</li>
<li>Larger inclusive value parameters mean <em>less</em> correlation between alternatives in that nest</li>
<li>Inclusive value parameters of 1—same as multinomial logit</li>
</ul>
</section>
<section id="nested-logit-caution" class="slide level2">
<h2>Nested logit: caution</h2>
<ul>
<li>In order to interpret coefficients from different nests relative to each other, you must use a random utility nested logit model (RUMNL)</li>
<li>These normalize the coefficients in each nest to be comparable to each other, by dividing by the inclusive value parameter</li>
<li>Non-normalized nested logit (NNNL) does not perform this normalization</li>
<li>RUMNL is default in Apollo, NNNL is default in Stata</li>
</ul>
</section>
<section id="nested-logit-caution-1" class="slide level2">
<h2>Nested logit: caution</h2>
<ul>
<li>Nested logit inclusive value parameters should be tested with a null hypothesis that they are 1, not 0</li>
<li>Many statistical packages (including Apollo) don’t do this</li>
<li>Thus, t-values and p-values will be incorrect</li>
</ul>
</section>
<section id="nested-logit-in-r" class="slide level2">
<h2>Nested logit in R</h2>
<div class="cell" data-filename="nested-logit-mode-choice.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-75_400cbd3adebd6e88f7a800f5089fd69b">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1"></a><span class="fu">library</span>(apollo)</span>
<span id="cb97-2"><a href="#cb97-2"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb97-3"><a href="#cb97-3"></a></span>
<span id="cb97-4"><a href="#cb97-4"></a>database <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="st">"data/modechoice_apollo.csv"</span>)</span>
<span id="cb97-5"><a href="#cb97-5"></a></span>
<span id="cb97-6"><a href="#cb97-6"></a><span class="fu">apollo_initialise</span>()</span>
<span id="cb97-7"><a href="#cb97-7"></a></span>
<span id="cb97-8"><a href="#cb97-8"></a>apollo_control <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb97-9"><a href="#cb97-9"></a>    <span class="at">modelName =</span> <span class="st">"Nested_Mode_Choice"</span>,</span>
<span id="cb97-10"><a href="#cb97-10"></a>    <span class="at">indivID=</span><span class="st">"ID"</span></span>
<span id="cb97-11"><a href="#cb97-11"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="nested-logit-mode-choice.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-76_2a7f509ee94443e7f292a45e49252659">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1"></a>apollo_beta <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb98-2"><a href="#cb98-2"></a>    <span class="at">asc_air =</span> <span class="dv">0</span>,</span>
<span id="cb98-3"><a href="#cb98-3"></a>    <span class="at">asc_bus =</span> <span class="dv">0</span>,</span>
<span id="cb98-4"><a href="#cb98-4"></a>    <span class="at">asc_rail =</span> <span class="dv">0</span>,</span>
<span id="cb98-5"><a href="#cb98-5"></a>    <span class="co"># leaving out an asc_car as base category</span></span>
<span id="cb98-6"><a href="#cb98-6"></a>    <span class="at">b_cost =</span> <span class="dv">0</span>,</span>
<span id="cb98-7"><a href="#cb98-7"></a>    <span class="at">b_access_time =</span> <span class="dv">0</span>,</span>
<span id="cb98-8"><a href="#cb98-8"></a>    <span class="at">b_in_vehicle_time =</span> <span class="dv">0</span>,</span>
<span id="cb98-9"><a href="#cb98-9"></a>    <span class="co"># income and party_size are individual level variable, so</span></span>
<span id="cb98-10"><a href="#cb98-10"></a>    <span class="co"># must be different for different alternatives</span></span>
<span id="cb98-11"><a href="#cb98-11"></a>    <span class="at">b_income_air =</span> <span class="dv">0</span>,</span>
<span id="cb98-12"><a href="#cb98-12"></a>    <span class="at">b_income_bus =</span> <span class="dv">0</span>,</span>
<span id="cb98-13"><a href="#cb98-13"></a>    <span class="at">b_income_rail =</span> <span class="dv">0</span>,</span>
<span id="cb98-14"><a href="#cb98-14"></a>    <span class="co"># This is the "nesting parameter" which captures how much variation</span></span>
<span id="cb98-15"><a href="#cb98-15"></a>    <span class="co"># occurs at each level</span></span>
<span id="cb98-16"><a href="#cb98-16"></a>    <span class="at">lambda_shared =</span> <span class="dv">1</span></span>
<span id="cb98-17"><a href="#cb98-17"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="nested-logit-mode-choice.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-77_7ae2ca4ddeb9b4c1659c50446b4467e8">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1"></a>apollo_fixed <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb99-2"><a href="#cb99-2"></a>apollo_inputs <span class="ot">=</span> <span class="fu">apollo_validateInputs</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Several observations per individual detected based on the value of ID.
  Setting panelData in apollo_control set to TRUE.
All checks on apollo_control completed.
All checks on database completed.</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="nested-logit-mode-choice.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-78_e975beddcf21e4eab795b428e4b6dc6e">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1"></a>apollo_probabilities <span class="ot">=</span> <span class="cf">function</span>(apollo_beta, apollo_inputs,</span>
<span id="cb101-2"><a href="#cb101-2"></a>        <span class="at">functionality=</span><span class="st">"estimate"</span>) {</span>
<span id="cb101-3"><a href="#cb101-3"></a>    <span class="fu">apollo_attach</span>(apollo_beta, apollo_inputs)</span>
<span id="cb101-4"><a href="#cb101-4"></a>    <span class="fu">on.exit</span>(<span class="fu">apollo_detach</span>(apollo_beta, apollo_inputs))</span>
<span id="cb101-5"><a href="#cb101-5"></a></span>
<span id="cb101-6"><a href="#cb101-6"></a>    P <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb101-7"><a href="#cb101-7"></a></span>
<span id="cb101-8"><a href="#cb101-8"></a>    <span class="co"># define utility functions</span></span>
<span id="cb101-9"><a href="#cb101-9"></a>    V <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb101-10"><a href="#cb101-10"></a>    <span class="co"># We can include cost and in-vehicle time here because</span></span>
<span id="cb101-11"><a href="#cb101-11"></a>    <span class="co"># they vary over alternatives</span></span>
<span id="cb101-12"><a href="#cb101-12"></a>    V[[<span class="st">"car"</span>]] <span class="ot">=</span> b_cost <span class="sc">*</span> cost_car <span class="sc">+</span></span>
<span id="cb101-13"><a href="#cb101-13"></a>        b_in_vehicle_time <span class="sc">*</span> time_car</span>
<span id="cb101-14"><a href="#cb101-14"></a></span>
<span id="cb101-15"><a href="#cb101-15"></a>    V[[<span class="st">"air"</span>]] <span class="ot">=</span> asc_air <span class="sc">+</span></span>
<span id="cb101-16"><a href="#cb101-16"></a>        b_cost <span class="sc">*</span> cost_air <span class="sc">+</span></span>
<span id="cb101-17"><a href="#cb101-17"></a>        b_in_vehicle_time <span class="sc">*</span> time_air <span class="sc">+</span></span>
<span id="cb101-18"><a href="#cb101-18"></a>        b_access_time <span class="sc">*</span> access_air <span class="sc">+</span></span>
<span id="cb101-19"><a href="#cb101-19"></a>        b_income_air <span class="sc">*</span> income</span>
<span id="cb101-20"><a href="#cb101-20"></a></span>
<span id="cb101-21"><a href="#cb101-21"></a>    V[[<span class="st">"rail"</span>]] <span class="ot">=</span> asc_rail <span class="sc">+</span></span>
<span id="cb101-22"><a href="#cb101-22"></a>        b_cost <span class="sc">*</span> cost_rail <span class="sc">+</span></span>
<span id="cb101-23"><a href="#cb101-23"></a>        b_in_vehicle_time <span class="sc">*</span> time_rail <span class="sc">+</span></span>
<span id="cb101-24"><a href="#cb101-24"></a>        b_access_time <span class="sc">*</span> access_rail <span class="sc">+</span></span>
<span id="cb101-25"><a href="#cb101-25"></a>        b_income_rail <span class="sc">*</span> income</span>
<span id="cb101-26"><a href="#cb101-26"></a></span>
<span id="cb101-27"><a href="#cb101-27"></a>    V[[<span class="st">"bus"</span>]] <span class="ot">=</span> asc_bus <span class="sc">+</span></span>
<span id="cb101-28"><a href="#cb101-28"></a>        b_cost <span class="sc">*</span> cost_bus <span class="sc">+</span></span>
<span id="cb101-29"><a href="#cb101-29"></a>        b_in_vehicle_time <span class="sc">*</span> time_bus <span class="sc">+</span></span>
<span id="cb101-30"><a href="#cb101-30"></a>        b_access_time <span class="sc">*</span> access_bus <span class="sc">+</span></span>
<span id="cb101-31"><a href="#cb101-31"></a>        b_income_bus <span class="sc">*</span> income</span>
<span id="cb101-32"><a href="#cb101-32"></a></span>
<span id="cb101-33"><a href="#cb101-33"></a>    <span class="do">## Now, we specify the nesting structure. First, we tell Apollo what</span></span>
<span id="cb101-34"><a href="#cb101-34"></a>    <span class="do">## nests we are using and their inclusive value parameters.</span></span>
<span id="cb101-35"><a href="#cb101-35"></a>    nlNests <span class="ot">=</span> <span class="fu">c</span>(<span class="at">root=</span><span class="dv">1</span>, <span class="at">shared=</span>lambda_shared)</span>
<span id="cb101-36"><a href="#cb101-36"></a></span>
<span id="cb101-37"><a href="#cb101-37"></a>    nlStructure <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb101-38"><a href="#cb101-38"></a>        <span class="at">root=</span><span class="fu">c</span>(<span class="st">"car"</span>, <span class="st">"shared"</span>),</span>
<span id="cb101-39"><a href="#cb101-39"></a>        <span class="at">shared=</span><span class="fu">c</span>(<span class="st">"rail"</span>, <span class="st">"bus"</span>, <span class="st">"air"</span>)</span>
<span id="cb101-40"><a href="#cb101-40"></a>    )</span>
<span id="cb101-41"><a href="#cb101-41"></a></span>
<span id="cb101-42"><a href="#cb101-42"></a>    nl_settings <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb101-43"><a href="#cb101-43"></a>        <span class="at">alternatives =</span> <span class="fu">c</span>(<span class="at">car=</span><span class="dv">1</span>, <span class="at">air=</span><span class="dv">3</span>, <span class="at">rail=</span><span class="dv">4</span>, <span class="at">bus=</span><span class="dv">2</span>),</span>
<span id="cb101-44"><a href="#cb101-44"></a>        <span class="at">avail =</span> <span class="fu">list</span>(<span class="at">car=</span>av_car, <span class="at">air=</span>av_air, <span class="at">rail=</span>av_rail, <span class="at">bus=</span>av_bus),</span>
<span id="cb101-45"><a href="#cb101-45"></a>        <span class="at">choiceVar =</span> choice,</span>
<span id="cb101-46"><a href="#cb101-46"></a>        <span class="at">utilities =</span> V,</span>
<span id="cb101-47"><a href="#cb101-47"></a>        <span class="at">nlNests =</span> nlNests,</span>
<span id="cb101-48"><a href="#cb101-48"></a>        <span class="at">nlStructure =</span> nlStructure</span>
<span id="cb101-49"><a href="#cb101-49"></a>    )</span>
<span id="cb101-50"><a href="#cb101-50"></a></span>
<span id="cb101-51"><a href="#cb101-51"></a>    P[[<span class="st">"model"</span>]] <span class="ot">=</span> <span class="fu">apollo_nl</span>(nl_settings, functionality)</span>
<span id="cb101-52"><a href="#cb101-52"></a></span>
<span id="cb101-53"><a href="#cb101-53"></a>    <span class="co"># For panel data, this multiplies observations for single individuals</span></span>
<span id="cb101-54"><a href="#cb101-54"></a>    <span class="co"># together - no effect in multinomial logit but still required.</span></span>
<span id="cb101-55"><a href="#cb101-55"></a>    P <span class="ot">=</span> <span class="fu">apollo_panelProd</span>(P, apollo_inputs, functionality)</span>
<span id="cb101-56"><a href="#cb101-56"></a>    P <span class="ot">=</span> <span class="fu">apollo_prepareProb</span>(P, apollo_inputs, functionality)</span>
<span id="cb101-57"><a href="#cb101-57"></a>    <span class="fu">return</span>(P)</span>
<span id="cb101-58"><a href="#cb101-58"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="nested-logit-mode-choice.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-79_41a9f2863759c1a42f2dd98ee01314d8">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1"></a>model <span class="ot">=</span></span>
<span id="cb102-2"><a href="#cb102-2"></a>    <span class="fu">apollo_estimate</span>(apollo_beta, apollo_fixed, apollo_probabilities, apollo_inputs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Preparing user-defined functions.
###############################################################################
The output of 'apollo_probabilities' has changed after the optimisation
  of the code carried out by Apollo. This indicates a problem, and the
  unoptimised and unscaled version will be used instead. Please contact
  the developers for assistance!
###############################################################################

Testing likelihood function...
Apollo found a model component of type NL without a componentName. The
  name was set to "NL" by default.

Overview of choices for NL model component NL:
                                    car    air   rail    bus
Times available                  778.00 752.00 874.00 902.00
Times chosen                     332.00 215.00 327.00 126.00
Percentage chosen overall         33.20  21.50  32.70  12.60
Percentage chosen when available  42.67  28.59  37.41  13.97

Nesting structure for NL model component NL:
Nest: root (1)
|----Alternative: car
'-Nest: shared (1)
   |-Alternative: rail
   |-Alternative: bus
   '-Alternative: air

Pre-processing likelihood function...

Testing influence of parameters..........
Starting main estimation
Initial function value: -1170.86 
Initial gradient value:
          asc_air           asc_bus          asc_rail            b_cost 
    -8.000001e+00     -1.536667e+02      5.966667e+01     -1.329167e+02 
    b_access_time b_in_vehicle_time      b_income_air      b_income_bus 
    -1.810417e+03     -1.898042e+04      3.114006e+05     -7.703172e+06 
    b_income_rail     lambda_shared 
     2.710651e+06     -9.000699e+01 
initial  value 1170.860076 
iter   2 value 1112.061643
iter   3 value 1098.117019
iter   4 value 1096.280213
iter   5 value 1088.844016
iter   6 value 1044.621361
iter   7 value 1043.544045
iter   8 value 1038.482398
iter   9 value 1027.377779
iter  10 value 1021.969637
iter  11 value 1020.575941
iter  12 value 1018.183515
iter  13 value 1017.447080
iter  14 value 1017.026693
iter  15 value 1016.519699
iter  16 value 1016.490275
iter  17 value 1016.454694
iter  18 value 1016.410877
iter  19 value 1016.401194
iter  20 value 1016.400942
iter  21 value 1016.400663
iter  21 value 1016.400660
iter  21 value 1016.400659
final  value 1016.400659 
converged
Estimated parameters:
                     Estimate
asc_air             -0.624118
asc_bus             -0.004930
asc_rail            -0.417880
b_cost              -0.022139
b_access_time       -0.004658
b_in_vehicle_time   -0.005133
b_income_air        6.077e-06
b_income_bus       -1.531e-05
b_income_rail      -8.683e-07
lambda_shared        0.600917

Computing covariance matrix using numerical methods (numDeriv).
 0%....25%....50%....75%....100%
Negative definite Hessian with maximum eigenvalue: -3.682404
Computing score matrix...
Nesting structure for NL model component NL:
Nest: root (1)
|----Alternative: car
'-Nest: shared (0.6009)
   |-Alternative: rail
   |-Alternative: bus
   '-Alternative: air

Calculating LL(0) for applicable models...
Calculating LL(c) for applicable models...
Calculating LL of each model component...</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="nested-logit-mode-choice.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-80_221040ff2576ef3d8e73e6c104f14c9a">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1"></a><span class="fu">apollo_modelOutput</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model run by mwbc using Apollo 0.2.7 on R 4.2.1 for Darwin.
www.ApolloChoiceModelling.com

Model name                       : Nested_Mode_Choice
Model description                : No model description provided in apollo_control
Model run at                     : 2022-08-10 12:28:27
Estimation method                : bfgs
Model diagnosis                  : successful convergence 
Number of individuals            : 500
Number of rows in database       : 1000
Number of modelled outcomes      : 1000

Number of cores used             :  1 
Model without mixing

LL(start)                        : -1170.86
LL(0)                            : -1170.86
LL(C)                            : -1085.14
LL(final)                        : -1016.4
Rho-square (0)                   :  0.1319 
Adj.Rho-square (0)               :  0.1234 
Rho-square (C)                   :  0.0634 
Adj.Rho-square (C)               :  0.0541 
AIC                              :  2052.8 
BIC                              :  2101.88 

Estimated parameters             :  10
Time taken (hh:mm:ss)            :  00:00:5.93 
     pre-estimation              :  00:00:5.12 
     estimation                  :  00:00:0.45 
     post-estimation             :  00:00:0.36 
Iterations                       :  24  
Min abs eigenvalue of Hessian    :  3.682404 

Unconstrained optimisation.

Estimates:
                     Estimate        s.e.   t.rat.(0)    Rob.s.e. Rob.t.rat.(0)
asc_air             -0.624118    0.405016    -1.54097    0.404818      -1.54172
asc_bus             -0.004930    0.295593    -0.01668    0.318353      -0.01548
asc_rail            -0.417880    0.307746    -1.35787    0.313907      -1.33122
b_cost              -0.022139    0.004683    -4.72802    0.004964      -4.46024
b_access_time       -0.004658    0.003872    -1.20290    0.003809      -1.22276
b_in_vehicle_time   -0.005133    0.001176    -4.36651    0.001178      -4.35697
b_income_air        6.077e-06   5.341e-06     1.13786   5.527e-06       1.09947
b_income_bus       -1.531e-05   6.178e-06    -2.47771   6.325e-06      -2.42027
b_income_rail      -8.683e-07   4.677e-06    -0.18563   4.773e-06      -0.18190
lambda_shared        0.600917    0.134525     4.46695    0.143280       4.19400

Nesting structure for NL model component NL:
Nest: root (1)
|----Alternative: car
'-Nest: shared (0.6009)
   |-Alternative: rail
   |-Alternative: bus
   '-Alternative: air</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="nested-logit-mode-choice.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-81_30e442e9cf41c740d982a48338b6b5a6">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1"></a><span class="fu">apollo_saveOutput</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model output saved to /Users/mwbc/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/teaching/odum-discrete/Nested_Mode_Choice_output.txt 
Estimates saved to /Users/mwbc/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/teaching/odum-discrete/Nested_Mode_Choice_estimates.csv 
Model object saved to /Users/mwbc/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/teaching/odum-discrete/Nested_Mode_Choice.rds </code></pre>
</div>
</div>
</section>
<section id="likelihood-ratio-tests-of-the-nested-logit-model" class="slide level2">
<h2>Likelihood-ratio tests of the nested logit model</h2>
<ul>
<li>We can perform a likelihood-ratio test, since constraining the inclusive value parameter to 1 would be the same as a multinomial logit model</li>
</ul>
</section>
<section class="slide level2">

<div class="cell" data-filename="nested-logit-mode-choice.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-82_0844d5d96628214a1f1366a6f429c2a5">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1"></a><span class="fu">apollo_lrTest</span>(<span class="st">"Nested_Mode_Choice"</span>, <span class="st">"Apollo_Mode_Choice"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The order of your two models will be reversed in the output as model 1
  has better fit than model 2.

                        LL par
Apollo_Mode_Choice -1020.0   9
Nested_Mode_Choice -1016.4  10
Difference             3.6   1

Likelihood ratio test-value:    7.2 
Degrees of freedom:             1 
Likelihood ratio test p-value:  0.00729 </code></pre>
</div>
</div>
</section></section>
<section>
<section id="mixed-logit" class="title-slide slide level1 center">
<h1>Mixed logit</h1>

</section>
<section id="mixed-logit-1" class="slide level2">
<h2>Mixed logit</h2>
<ul>
<li>In multinomial logit and nested logit models, parameters are assumed to be constant across the population</li>
<li>Mixed logit allows (a subset of) coefficients to vary across individuals</li>
</ul>
</section>
<section id="mixed-logit-as-an-alternative-to-nested-logit" class="slide level2">
<h2>Mixed logit as an alternative to nested logit</h2>
<ul>
<li>By creating random coefficients that enter multiple utility functions as constants, correlations can be created</li>
<li>Basically, using random coefficients as additional shared error terms</li>
</ul>
</section>
<section id="mixed-logit-2" class="slide level2">
<h2>Mixed logit</h2>
<p>We might write our nested model above as</p>
<p><span class="math display">\[
U_{car} = X_{car}B_{car} + \epsilon_{car}
\]</span></p>
<p><span class="math display">\[
U_{bus} = X_{bus}B_{bus} + \mu'_{shared} + \epsilon_{bus}
\]</span></p>
<p><span class="math display">\[
U_{rail} = X_{rail}B_{rail} + \mu'_{shared} + \epsilon_{rail}
\]</span></p>
<p><span class="math display">\[
U_{air} = X_{air}B_{air} + \mu'_{shared} + \epsilon_{air}
\]</span></p>
<p><span class="math inline">\(\mu'_{shared}\)</span> is a random value which acts as a common error term for the shared modes</p>
</section>
<section id="mixed-logit-probabilities" class="slide level2">
<h2>Mixed logit: probabilities</h2>
<ul>
<li>The mixed logit probability is the same as the multinomial logit probability, but integrated over the random coefficients</li>
<li>This is usually done through simulation
<ul>
<li>Random draws are taken from the coefficient distribution, the likelihood is calculated for each, and then they are averaged together</li>
</ul></li>
</ul>
</section>
<section id="mixed-logit-3" class="slide level2">
<h2>Mixed logit</h2>
<ul>
<li>Mixed logit can also have coefficients that vary randomly</li>
<li>Common use is value of time - we know this varies a lot across the population</li>
<li>For more information on mixed logit models, see <span class="citation" data-cites="train_discrete_2009">Train (<a href="#/ref-train_discrete_2009" role="doc-biblioref" onclick="return false;">2009</a>)</span> (free ebook available) and the Apollo manual</li>
</ul>
</section>
<section id="mixed-logit-in-r" class="slide level2">
<h2>Mixed logit in R</h2>
<div class="cell" data-filename="mixed-logit-mode-choice.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-84_4b0861f19a8c7a1d3eb0b483cca779d1">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1"></a><span class="fu">library</span>(apollo)</span>
<span id="cb110-2"><a href="#cb110-2"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb110-3"><a href="#cb110-3"></a></span>
<span id="cb110-4"><a href="#cb110-4"></a>database <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="st">"data/modechoice_apollo.csv"</span>)</span>
<span id="cb110-5"><a href="#cb110-5"></a></span>
<span id="cb110-6"><a href="#cb110-6"></a><span class="fu">apollo_initialise</span>()</span>
<span id="cb110-7"><a href="#cb110-7"></a></span>
<span id="cb110-8"><a href="#cb110-8"></a>apollo_control <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb110-9"><a href="#cb110-9"></a>    <span class="at">modelName =</span> <span class="st">"Mixed_Mode_Choice"</span>,</span>
<span id="cb110-10"><a href="#cb110-10"></a>    <span class="at">indivID=</span><span class="st">"ID"</span>,</span>
<span id="cb110-11"><a href="#cb110-11"></a>    <span class="at">mixing =</span> T</span>
<span id="cb110-12"><a href="#cb110-12"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="mixed-logit-mode-choice.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-85_1c412d5ba2a01ff9dfb53f0ded15a938">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1"></a>apollo_beta <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb111-2"><a href="#cb111-2"></a>    <span class="at">asc_air =</span> <span class="dv">0</span>,</span>
<span id="cb111-3"><a href="#cb111-3"></a>    <span class="at">asc_bus =</span> <span class="dv">0</span>,</span>
<span id="cb111-4"><a href="#cb111-4"></a>    <span class="at">asc_rail =</span> <span class="dv">0</span>,</span>
<span id="cb111-5"><a href="#cb111-5"></a>    <span class="co"># leaving out an asc_car as base category</span></span>
<span id="cb111-6"><a href="#cb111-6"></a>    <span class="at">b_cost =</span> <span class="dv">0</span>,</span>
<span id="cb111-7"><a href="#cb111-7"></a>    <span class="at">b_access_time =</span> <span class="dv">0</span>,</span>
<span id="cb111-8"><a href="#cb111-8"></a>    <span class="at">b_in_vehicle_time =</span> <span class="dv">0</span>,</span>
<span id="cb111-9"><a href="#cb111-9"></a>    <span class="co"># income and party_size are individual level variable, so</span></span>
<span id="cb111-10"><a href="#cb111-10"></a>    <span class="co"># must be different for different alternatives</span></span>
<span id="cb111-11"><a href="#cb111-11"></a>    <span class="at">b_income_air =</span> <span class="dv">0</span>,</span>
<span id="cb111-12"><a href="#cb111-12"></a>    <span class="at">b_income_bus =</span> <span class="dv">0</span>,</span>
<span id="cb111-13"><a href="#cb111-13"></a>    <span class="at">b_income_rail =</span> <span class="dv">0</span>,</span>
<span id="cb111-14"><a href="#cb111-14"></a>    <span class="co"># This is the standard deviation of the shared error component</span></span>
<span id="cb111-15"><a href="#cb111-15"></a>    <span class="co"># random term, which will be normally distributed.</span></span>
<span id="cb111-16"><a href="#cb111-16"></a>    <span class="at">sd_shared =</span> <span class="dv">1</span></span>
<span id="cb111-17"><a href="#cb111-17"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="defining-draws" class="slide level2">
<h2>Defining draws</h2>
<ul>
<li>We need to tell Apollo what random variable we have</li>
<li>Since log-likelihood is simulated, these are called “draws”</li>
<li>Halton draws are common since they provide good distribution</li>
<li>Most often in panel data, draws vary at the individual level
<ul>
<li>i.e.&nbsp;an individual has the same random coefficient for all choices</li>
</ul></li>
</ul>
</section>
<section class="slide level2">

<div class="cell" data-filename="mixed-logit-mode-choice.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-86_40017f9568e5f1c34596517149faf813">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1"></a>apollo_draws <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb112-2"><a href="#cb112-2"></a>    <span class="at">interDrawsType=</span><span class="st">"halton"</span>,</span>
<span id="cb112-3"><a href="#cb112-3"></a>    <span class="co"># number of draws - more is slower but more accurate</span></span>
<span id="cb112-4"><a href="#cb112-4"></a>    <span class="at">interNDraws=</span><span class="dv">500</span>,</span>
<span id="cb112-5"><a href="#cb112-5"></a>    <span class="co"># no uniformly-distributed random variables</span></span>
<span id="cb112-6"><a href="#cb112-6"></a>    <span class="at">interUnifDraws=</span><span class="fu">c</span>(),</span>
<span id="cb112-7"><a href="#cb112-7"></a>    <span class="co"># one normally-distributed random variable</span></span>
<span id="cb112-8"><a href="#cb112-8"></a>    <span class="at">interNormDraws=</span><span class="fu">c</span>(<span class="st">"draws_shared_mode_error"</span>)</span>
<span id="cb112-9"><a href="#cb112-9"></a>    <span class="co"># can also use intraNDraws etc. for intra-individual draws</span></span>
<span id="cb112-10"><a href="#cb112-10"></a>    <span class="co"># (less common)</span></span>
<span id="cb112-11"><a href="#cb112-11"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="defining-random-coefficients" class="slide level2">
<h2>Defining random coefficients</h2>
<ul>
<li>Based on the draws, we then define an <code>apollo_randCoeff</code> function that transforms them as needed to the desired form</li>
</ul>
</section>
<section class="slide level2">

<div class="cell" data-filename="mixed-logit-mode-choice.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-87_c8557ab350dee11067f813c719048afb">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1"></a>apollo_randCoeff <span class="ot">=</span> <span class="cf">function</span> (apollo_beta, apollo_inputs) {</span>
<span id="cb113-2"><a href="#cb113-2"></a>    randcoeff <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb113-3"><a href="#cb113-3"></a>    <span class="co"># error term has mean zero, so we multiply by standard deviation</span></span>
<span id="cb113-4"><a href="#cb113-4"></a>    <span class="co"># but do not add an offset</span></span>
<span id="cb113-5"><a href="#cb113-5"></a>    <span class="co"># anything we add to this list will be available in apollo_probabilities</span></span>
<span id="cb113-6"><a href="#cb113-6"></a>    randcoeff[[<span class="st">"shared_mode_error"</span>]] <span class="ot">=</span> sd_shared <span class="sc">*</span> draws_shared_mode_error</span>
<span id="cb113-7"><a href="#cb113-7"></a></span>
<span id="cb113-8"><a href="#cb113-8"></a>    <span class="fu">return</span>(randcoeff)</span>
<span id="cb113-9"><a href="#cb113-9"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-filename="mixed-logit-mode-choice.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-88_a8492a5de6e1a012e8eeccd18fa63bca">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1"></a>apollo_fixed <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb114-2"><a href="#cb114-2"></a>apollo_inputs <span class="ot">=</span> <span class="fu">apollo_validateInputs</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>apollo_draws and apollo_randCoeff were found, so apollo_control$mixing
  was set to TRUE
Several observations per individual detected based on the value of ID.
  Setting panelData in apollo_control set to TRUE.
All checks on apollo_control completed.
All checks on database completed.
Generating inter-individual draws . Done</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="mixed-logit-mode-choice.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-89_f59143d669db5c43f15643bb0caf3617">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1"></a>apollo_probabilities <span class="ot">=</span> <span class="cf">function</span>(apollo_beta, apollo_inputs,</span>
<span id="cb116-2"><a href="#cb116-2"></a>        <span class="at">functionality=</span><span class="st">"estimate"</span>) {</span>
<span id="cb116-3"><a href="#cb116-3"></a>    <span class="fu">apollo_attach</span>(apollo_beta, apollo_inputs)</span>
<span id="cb116-4"><a href="#cb116-4"></a>    <span class="fu">on.exit</span>(<span class="fu">apollo_detach</span>(apollo_beta, apollo_inputs))</span>
<span id="cb116-5"><a href="#cb116-5"></a></span>
<span id="cb116-6"><a href="#cb116-6"></a>    P <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb116-7"><a href="#cb116-7"></a></span>
<span id="cb116-8"><a href="#cb116-8"></a>    <span class="co"># define utility functions</span></span>
<span id="cb116-9"><a href="#cb116-9"></a>    V <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb116-10"><a href="#cb116-10"></a>    <span class="co"># We can include cost and in-vehicle time here because</span></span>
<span id="cb116-11"><a href="#cb116-11"></a>    <span class="co"># they vary over alternatives</span></span>
<span id="cb116-12"><a href="#cb116-12"></a>    V[[<span class="st">"car"</span>]] <span class="ot">=</span> b_cost <span class="sc">*</span> cost_car <span class="sc">+</span></span>
<span id="cb116-13"><a href="#cb116-13"></a>        b_in_vehicle_time <span class="sc">*</span> time_car</span>
<span id="cb116-14"><a href="#cb116-14"></a></span>
<span id="cb116-15"><a href="#cb116-15"></a>    V[[<span class="st">"air"</span>]] <span class="ot">=</span> asc_air <span class="sc">+</span></span>
<span id="cb116-16"><a href="#cb116-16"></a>        b_cost <span class="sc">*</span> cost_air <span class="sc">+</span></span>
<span id="cb116-17"><a href="#cb116-17"></a>        b_in_vehicle_time <span class="sc">*</span> time_air <span class="sc">+</span></span>
<span id="cb116-18"><a href="#cb116-18"></a>        b_access_time <span class="sc">*</span> access_air <span class="sc">+</span></span>
<span id="cb116-19"><a href="#cb116-19"></a>        b_income_air <span class="sc">*</span> income <span class="sc">+</span></span>
<span id="cb116-20"><a href="#cb116-20"></a>        shared_mode_error</span>
<span id="cb116-21"><a href="#cb116-21"></a></span>
<span id="cb116-22"><a href="#cb116-22"></a>    V[[<span class="st">"rail"</span>]] <span class="ot">=</span> asc_rail <span class="sc">+</span></span>
<span id="cb116-23"><a href="#cb116-23"></a>        b_cost <span class="sc">*</span> cost_rail <span class="sc">+</span></span>
<span id="cb116-24"><a href="#cb116-24"></a>        b_in_vehicle_time <span class="sc">*</span> time_rail <span class="sc">+</span></span>
<span id="cb116-25"><a href="#cb116-25"></a>        b_access_time <span class="sc">*</span> access_rail <span class="sc">+</span></span>
<span id="cb116-26"><a href="#cb116-26"></a>        b_income_rail <span class="sc">*</span> income <span class="sc">+</span></span>
<span id="cb116-27"><a href="#cb116-27"></a>        shared_mode_error</span>
<span id="cb116-28"><a href="#cb116-28"></a></span>
<span id="cb116-29"><a href="#cb116-29"></a>    V[[<span class="st">"bus"</span>]] <span class="ot">=</span> asc_bus <span class="sc">+</span></span>
<span id="cb116-30"><a href="#cb116-30"></a>        b_cost <span class="sc">*</span> cost_bus <span class="sc">+</span></span>
<span id="cb116-31"><a href="#cb116-31"></a>        b_in_vehicle_time <span class="sc">*</span> time_bus <span class="sc">+</span></span>
<span id="cb116-32"><a href="#cb116-32"></a>        b_access_time <span class="sc">*</span> access_bus <span class="sc">+</span></span>
<span id="cb116-33"><a href="#cb116-33"></a>        b_income_bus <span class="sc">*</span> income <span class="sc">+</span></span>
<span id="cb116-34"><a href="#cb116-34"></a>        shared_mode_error</span>
<span id="cb116-35"><a href="#cb116-35"></a></span>
<span id="cb116-36"><a href="#cb116-36"></a>    <span class="co"># mathematically, this is still a multinomial logit model,</span></span>
<span id="cb116-37"><a href="#cb116-37"></a>    <span class="co"># just integrated over our random variables</span></span>
<span id="cb116-38"><a href="#cb116-38"></a>    mnl_settings <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb116-39"><a href="#cb116-39"></a>        <span class="at">alternatives =</span> <span class="fu">c</span>(<span class="at">car=</span><span class="dv">1</span>, <span class="at">air=</span><span class="dv">3</span>, <span class="at">rail=</span><span class="dv">4</span>, <span class="at">bus=</span><span class="dv">2</span>),</span>
<span id="cb116-40"><a href="#cb116-40"></a>        <span class="at">avail =</span> <span class="fu">list</span>(<span class="at">car=</span>av_car, <span class="at">air=</span>av_air, <span class="at">rail=</span>av_rail, <span class="at">bus=</span>av_bus),</span>
<span id="cb116-41"><a href="#cb116-41"></a>        <span class="at">choiceVar =</span> choice,</span>
<span id="cb116-42"><a href="#cb116-42"></a>        <span class="at">utilities =</span> V</span>
<span id="cb116-43"><a href="#cb116-43"></a>    )</span>
<span id="cb116-44"><a href="#cb116-44"></a></span>
<span id="cb116-45"><a href="#cb116-45"></a>    P[[<span class="st">"model"</span>]] <span class="ot">=</span> <span class="fu">apollo_mnl</span>(mnl_settings, functionality)</span>
<span id="cb116-46"><a href="#cb116-46"></a></span>
<span id="cb116-47"><a href="#cb116-47"></a>    <span class="co"># we need to average the draws together. Because of the structure of the</span></span>
<span id="cb116-48"><a href="#cb116-48"></a>    <span class="co"># mixed logit model, intra-individual draws need to be averaged before</span></span>
<span id="cb116-49"><a href="#cb116-49"></a>    <span class="co"># joint choices in a panel are multiplied together, while inter-individual</span></span>
<span id="cb116-50"><a href="#cb116-50"></a>    <span class="co"># need to be averaged after. If we had intra-individual draws, the line below</span></span>
<span id="cb116-51"><a href="#cb116-51"></a>    <span class="co"># would average them. But since we don't, it's commented out.</span></span>
<span id="cb116-52"><a href="#cb116-52"></a>    <span class="co"># P = apollo_avgIntraDraws(P, apollo_inputs, functionality)</span></span>
<span id="cb116-53"><a href="#cb116-53"></a></span>
<span id="cb116-54"><a href="#cb116-54"></a>    <span class="co"># For panel data, this multiplies observations for single individuals</span></span>
<span id="cb116-55"><a href="#cb116-55"></a>    <span class="co"># together - no effect in multinomial logit but still required.</span></span>
<span id="cb116-56"><a href="#cb116-56"></a>    P <span class="ot">=</span> <span class="fu">apollo_panelProd</span>(P, apollo_inputs, functionality)</span>
<span id="cb116-57"><a href="#cb116-57"></a></span>
<span id="cb116-58"><a href="#cb116-58"></a>    <span class="co"># now average across inter-individual draws</span></span>
<span id="cb116-59"><a href="#cb116-59"></a>    P <span class="ot">=</span> <span class="fu">apollo_avgInterDraws</span>(P, apollo_inputs, functionality)</span>
<span id="cb116-60"><a href="#cb116-60"></a></span>
<span id="cb116-61"><a href="#cb116-61"></a>    P <span class="ot">=</span> <span class="fu">apollo_prepareProb</span>(P, apollo_inputs, functionality)</span>
<span id="cb116-62"><a href="#cb116-62"></a>    <span class="fu">return</span>(P)</span>
<span id="cb116-63"><a href="#cb116-63"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="mixed-logit-mode-choice.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-90_a5a5d4534329d779ff5c382342ac64de">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1"></a>model <span class="ot">=</span></span>
<span id="cb117-2"><a href="#cb117-2"></a>    <span class="fu">apollo_estimate</span>(apollo_beta, apollo_fixed, apollo_probabilities, apollo_inputs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>###############################################################################
WARNING: You can use multiple processor cores to speed up estimation.
  To do so, specify the desired number of cores using the setting
  nCores inside "apollo_control", for example "nCores=2". This computer
  has 8 available cores. We recommend using no more than 7 cores.
###############################################################################
Preparing user-defined functions.

Testing likelihood function...

Overview of choices for MNL model component :
                                    car    air   rail    bus
Times available                  778.00 752.00 874.00 902.00
Times chosen                     332.00 215.00 327.00 126.00
Percentage chosen overall         33.20  21.50  32.70  12.60
Percentage chosen when available  42.67  28.59  37.41  13.97

Pre-processing likelihood function...
Analytical gradient is different to numerical one. Numerical gradients
  will be used.

Testing influence of parameters..........
Starting main estimation
Initial function value: -1159.908 
Initial gradient value:
          asc_air           asc_bus          asc_rail            b_cost 
     5.536533e+00     -1.372506e+02      7.455439e+01      4.467259e+02 
    b_access_time b_in_vehicle_time      b_income_air      b_income_bus 
    -7.256794e+02     -2.343829e+04      8.982552e+05     -6.938264e+06 
    b_income_rail         sd_shared 
     3.391037e+06      2.166185e+00 
initial  value 1159.908499 
iter   2 value 1106.484746
iter   3 value 1099.384089
iter   4 value 1096.880363
iter   5 value 1078.658951
iter   6 value 1047.220856
iter   7 value 1046.473696
iter   8 value 1045.723548
iter   9 value 1038.006031
iter  10 value 1035.506402
iter  11 value 1029.221624
iter  12 value 1022.050074
iter  13 value 1020.251104
iter  14 value 1019.419488
iter  15 value 1019.370695
iter  16 value 1019.354945
iter  17 value 1019.354411
iter  18 value 1019.354361
iter  18 value 1019.354359
iter  18 value 1019.354359
final  value 1019.354359 
converged
Additional convergence test using scaled estimation. Parameters will be
  scaled by their current estimates and additional iterations will be
  performed.
initial  value 1019.354359 
iter   1 value 1019.354359
final  value 1019.354359 
converged
Estimated parameters:
                     Estimate
asc_air             -0.920404
asc_bus             -0.337753
asc_rail            -0.673404
b_cost              -0.032709
b_access_time       -0.006553
b_in_vehicle_time   -0.006329
b_income_air        1.046e-05
b_income_bus       -2.302e-05
b_income_rail       4.347e-07
sd_shared            0.512083

Computing covariance matrix using numerical methods (numDeriv).
 0%....25%....50%....75%....100%
Negative definite Hessian with maximum eigenvalue: -2.823983
Computing score matrix...
Calculating LL(0) for applicable models...
Calculating LL(c) for applicable models...
Calculating LL of each model component...</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="mixed-logit-mode-choice.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-91_0f7d488f8fbf9c33769bfde527eec13e">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1"></a><span class="fu">apollo_modelOutput</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model run by mwbc using Apollo 0.2.7 on R 4.2.1 for Darwin.
www.ApolloChoiceModelling.com

Model name                       : Mixed_Mode_Choice
Model description                : No model description provided in apollo_control
Model run at                     : 2022-08-10 12:28:33
Estimation method                : bfgs
Model diagnosis                  : successful convergence 
Number of individuals            : 500
Number of rows in database       : 1000
Number of modelled outcomes      : 1000

Number of cores used             :  1 
Number of inter-individual draws : 500 (halton)

LL(start)                        : -1159.91
LL(0)                            : -1170.86
LL(C)                            : -1085.14
LL(final)                        : -1019.35
Rho-square (0)                   :  0.1294 
Adj.Rho-square (0)               :  0.1209 
Rho-square (C)                   :  0.0606 
Adj.Rho-square (C)               :  0.0514 
AIC                              :  2058.71 
BIC                              :  2107.79 

Estimated parameters             :  10
Time taken (hh:mm:ss)            :  00:01:16.67 
     pre-estimation              :  00:00:11.36 
     estimation                  :  00:00:33.95 
     post-estimation             :  00:00:31.36 
Iterations                       :  24  
Min abs eigenvalue of Hessian    :  2.823983 

Unconstrained optimisation.

Estimates:
                     Estimate        s.e.   t.rat.(0)    Rob.s.e. Rob.t.rat.(0)
asc_air             -0.920404    0.518006    -1.77682    0.511855      -1.79817
asc_bus             -0.337753    0.330029    -1.02340    0.317969      -1.06222
asc_rail            -0.673404    0.348736    -1.93098    0.354534      -1.89940
b_cost              -0.032709    0.003352    -9.75733    0.003275      -9.98791
b_access_time       -0.006553    0.006028    -1.08714    0.005897      -1.11127
b_in_vehicle_time   -0.006329    0.001353    -4.67690    0.001432      -4.41906
b_income_air        1.046e-05   6.187e-06     1.69001   6.206e-06       1.68482
b_income_bus       -2.302e-05   7.023e-06    -3.27748   6.749e-06      -3.41048
b_income_rail       4.347e-07   5.418e-06     0.08023   5.402e-06       0.08047
sd_shared            0.512083    0.249167     2.05518    0.257106       1.99172</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<div class="cell" data-filename="mixed-logit-mode-choice.R" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-92_19fd930ccbd44f7f1d955c3583ca5706">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1"></a><span class="fu">apollo_saveOutput</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model output saved to /Users/mwbc/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/teaching/odum-discrete/Mixed_Mode_Choice_output.txt 
Estimates saved to /Users/mwbc/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/teaching/odum-discrete/Mixed_Mode_Choice_estimates.csv 
Model object saved to /Users/mwbc/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/teaching/odum-discrete/Mixed_Mode_Choice.rds </code></pre>
</div>
</div>
</section>
<section id="likelihood-ratio-test-for-mixed-logit" class="slide level2">
<h2>Likelihood-ratio test for mixed logit</h2>
<ul>
<li>Cannot compare to nested logit (why?) . . .
<ul>
<li>Models are non-nested, cannot reduce this mixed logit model to nested logit</li>
</ul></li>
<li>Can compare to multinomial logit (with what constraint?) . . .
<ul>
<li>Constrain standard deviation to zero</li>
</ul></li>
</ul>
</section>
<section class="slide level2">

<div class="cell" data-hash="discrete-choice_cache/revealjs/unnamed-chunk-93_34b419eb2eb7c41bbc889e0ada4a1122">
<div class="cell-output cell-output-stdout">
<pre><code>The order of your two models will be reversed in the output as model 1
  has better fit than model 2.

                         LL par
Apollo_Mode_Choice -1020.00   9
Mixed_Mode_Choice  -1019.35  10
Difference             0.65   1

Likelihood ratio test-value:    1.3 
Degrees of freedom:             1 
Likelihood ratio test p-value:  0.2542 </code></pre>
</div>
</div>
</section>
<section id="interpreting-mixed-logit-models" class="slide level2">
<h2>Interpreting mixed logit models</h2>
<ul>
<li>Error components model: standard deviations of error terms and their significance is proportional to correlation between alternatives
<ul>
<li>opposite of nested logit, where smaller inclusive value parameters mean more correlation</li>
</ul></li>
<li>Can also have random coefficients
<ul>
<li>Usually a mean is added to the coefficients in this case</li>
<li>Often used for value of time</li>
</ul></li>
</ul>
</section>
<section id="interpreting-mixed-logit-models-1" class="slide level2">
<h2>Interpreting mixed logit models</h2>
<ul>
<li>Be careful with valuation
<ul>
<li>Ratio of normally distributed coefficients is Cauchy distributed</li>
<li>Known as a “pathological” distribution - no mean</li>
<li>Probably not economically consistent; even Jeff Bezos doesn’t have infinite value of time</li>
</ul></li>
</ul>
</section>
<section id="questions-and-contact" class="slide level2">
<h2>Questions and contact</h2>
<p>Matt Bhagat-Conway</p>
<p><a href="mailto:mwbc@unc.edu">mwbc@unc.edu</a></p>
<p><a href="https://twitter.com/mattwigway">@mattwigway</a></p>
</section>
<section id="references" class="slide level2 smaller scrollable">
<h2>References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-ben-akiva_discrete_1985" class="csl-entry" role="doc-biblioentry">
Ben-Akiva, Moshe, and Stephen R Lerman. 1985. <em>Discrete <span>Choice Analysis</span>: <span>Theory</span> and <span>Application</span> to <span>Travel Demand</span></em>. <span>MIT Press</span>.
</div>
<div id="ref-daly_estimating_2020" class="csl-entry" role="doc-biblioentry">
Daly, Andrew, Stephane Hess, and Juan de Dios Ortúzar. 2020. <span>“Estimating Willingness-to-Pay from Discrete Choice Models: Setting the Record Straight.”</span> <a href="http://www.stephanehess.me.uk/papers/working_papers/Daly_Hess_Ortuzar_2020.pdf">http://www.stephanehess.me.uk/papers/working_papers/Daly_Hess_Ortuzar_2020.pdf</a>.
</div>
<div id="ref-train_discrete_2009" class="csl-entry" role="doc-biblioentry">
Train, Kenneth. 2009. <em>Discrete <span>Choice Methods</span> with <span>Simulation</span></em>. <span>Cambridge, UK</span>: <span>Cambridge University Press</span>.
</div>
</div>


<img src="dm-logo.png" class="slide-logo r-stretch"><div class="footer footer-default">

</div>
</section></section>
    </div>
  </div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="site_libs/revealjs/plugin/search/search.js"></script>
  <script src="site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'smaller': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: false,

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1280,

        height: 720,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    
    <script>
      // htmlwidgets need to know to resize themselves when slides are shown/hidden.
      // Fire the "slideenter" event (handled by htmlwidgets.js) when the current
      // slide changes (different for each slide format).
      (function () {
        function fireSlideChanged(previousSlide, currentSlide) {

          // dispatch for htmlwidgets
          const event = window.document.createEvent("Event");
          event.initEvent("slideenter", true, true);
          window.document.dispatchEvent(event);

          // dispatch for shiny
          if (window.jQuery) {
            if (previousSlide) {
              window.jQuery(previousSlide).trigger("hidden");
            }
            if (currentSlide) {
              window.jQuery(currentSlide).trigger("shown");
            }
          }
        }

        // hookup for reveal
        if (window.Reveal) {
          window.Reveal.addEventListener("slidechanged", function(event) {
            fireSlideChanged(event.previousSlide, event.currentSlide);
          });
        }

        // hookup for slidy
        if (window.w3c_slidy) {
          window.w3c_slidy.add_observer(function (slide_num) {
            // slide_num starts at position 1
            fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);
          });
        }

      })();
    </script>

    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const clipboard = new window.ClipboardJS('.code-copy-button', {
        target: function(trigger) {
          return trigger.previousElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        setTimeout(function() {
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      });
      function tippyHover(el, contentFn) {
        const config = {
          allowHTML: true,
          content: contentFn,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto-reveal',
          placement: 'bottom-start'
        };
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          let href = ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          return note.innerHTML;
        });
      }
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const cites = ref.parentNode.getAttribute('data-cites').split(' ');
        tippyHover(ref, function() {
          var popup = window.document.createElement('div');
          cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    });
    </script>
    

</body></html>